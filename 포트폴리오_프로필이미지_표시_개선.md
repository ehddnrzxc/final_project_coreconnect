# ì±„íŒ…ë°© ìƒì„± íŒì—… í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥ ê°œì„ 

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”
- **í”„ë¡œì íŠ¸ëª…**: CoreConnect ì±„íŒ… ì‹œìŠ¤í…œ
- **ê°œì„  ì¼ì**: 2024ë…„
- **ê°œì„  ì˜ì—­**: ì±„íŒ…ë°© ìƒì„± íŒì—…ì˜ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥

---

## ğŸ”´ AS-IS (ë¬¸ì œ ìƒí™©)

### ë¬¸ì œì 
ì±„íŒ…ë°© ìƒì„± íŒì—…ì—ì„œ ì‚¬ìš©ì ëª©ë¡ì„ ì¡°íšŒí•  ë•Œ, ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ëª©ë¡ì—ëŠ” ì´ë‹ˆì…œë§Œ í‘œì‹œë˜ê³  ì‹¤ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë Œë”ë§ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### ê¸°ìˆ ì  ë¬¸ì œ ë¶„ì„

#### 1. ë°±ì—”ë“œ ë¬¸ì œì 
```java
// âŒ AS-IS: UserServiceImpl.findAllUsers()
public List<UserDTO> findAllUsers() {
    return userRepository.findAll()  // Departmentë¥¼ í•¨ê»˜ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        .stream()
        .map(UserDTO::toDTO)  // profileImageUrlì´ nullë¡œ ì„¤ì •ë¨
        .toList();
}
```

**ë¬¸ì œì :**
- `userRepository.findAll()`ì„ ì‚¬ìš©í•˜ì—¬ Departmentë¥¼ í•¨ê»˜ ë¡œë“œí•˜ì§€ ì•Šì•„ LazyInitializationException ë°œìƒ ê°€ëŠ¥
- `UserDTO.toDTO()` ë©”ì„œë“œì—ì„œ `profileImageUrl`ì„ `null`ë¡œ ì„¤ì •
- `user_profile_image_key`ë¥¼ S3 URLë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§ì´ ì—†ìŒ
- `OrganizationUserResponseDTO`ì— `profileImageUrl` í•„ë“œê°€ ì—†ìŒ

#### 2. í”„ë¡ íŠ¸ì—”ë“œ ë¬¸ì œì 
```jsx
// âŒ AS-IS: ChatRoomCreateDialog.jsx
<Avatar
  src={user.profileImageUrl}  // undefined ë˜ëŠ” null
  sx={{ bgcolor: "#10c16d", width: 40, height: 40 }}
>
  {user.name?.[0]?.toUpperCase() || "?"}
</Avatar>
```

**ë¬¸ì œì :**
- ë°±ì—”ë“œì—ì„œ `profileImageUrl`ì„ ë°˜í™˜í•˜ì§€ ì•Šì•„ `undefined` ë˜ëŠ” `null` ê°’ ì „ë‹¬
- ë¹ˆ ë¬¸ìì—´(`""`)ì„ `src`ì— ì „ë‹¬í•˜ë©´ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ê°€ ë°œìƒí•˜ì—¬ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë°œìƒ
- ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ê°€ ì—†ì–´ ë¬¸ì œ ì›ì¸ íŒŒì•…ì´ ì–´ë ¤ì›€

### ì˜í–¥ë„ ë¶„ì„
- **ì‚¬ìš©ì ê²½í—˜**: í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•Šì•„ ì‚¬ìš©ì ì‹ë³„ì´ ì–´ë ¤ì›€
- **ì‹œê°ì  ì¼ê´€ì„±**: ë‹¤ë¥¸ í™”ë©´ì—ì„œëŠ” í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ë§Œ ì±„íŒ…ë°© ìƒì„± íŒì—…ì—ì„œëŠ” í‘œì‹œë˜ì§€ ì•Šì•„ UI ì¼ê´€ì„± ì €í•˜
- **ê¸°ëŠ¥ ì™„ì„±ë„**: ì±„íŒ…ë°© ìƒì„± ê¸°ëŠ¥ì€ ë™ì‘í•˜ì§€ë§Œ ì‚¬ìš©ì ê²½í—˜ ì¸¡ë©´ì—ì„œ ë¯¸ì™„ì„± ìƒíƒœ

---

## ğŸŸ¢ TO-BE (í•´ê²° ë°©ì•ˆ)

### í•´ê²° ì „ëµ
1. **ë°±ì—”ë“œ ê°œì„ **: `user_profile_image_key`ë¥¼ S3 URLë¡œ ë³€í™˜í•˜ì—¬ `profileImageUrl`ë¡œ ë°˜í™˜
2. **ë°ì´í„° ë¡œë”© ìµœì í™”**: Departmentì™€ í•¨ê»˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œë“œí•˜ì—¬ N+1 ë¬¸ì œ ë°©ì§€
3. **í”„ë¡ íŠ¸ì—”ë“œ ê°œì„ **: `profileImageUrl`ì„ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©í•˜ê³  ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

### êµ¬í˜„ ë‚´ìš©

#### 1. ë°±ì—”ë“œ ê°œì„ 

##### 1.1 UserServiceImpl.findAllUsers() ê°œì„ 
```java
// âœ… TO-BE: UserServiceImpl.findAllUsers()
@Override
@Transactional(readOnly = true)
public List<UserDTO> findAllUsers() {
    // Departmentë¥¼ í•¨ê»˜ ë¡œë“œí•˜ì—¬ LazyInitializationException ë°©ì§€
    return userRepository.findAllWithDepartment()
        .stream()
        .map(user -> {
            UserDTO dto = UserDTO.toDTO(user);
            
            // user.getProfileImageKey()ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ S3 URLë¡œ ë³€í™˜
            String imageUrl = "";
            String profileImageKey = user.getProfileImageKey();
            
            if (profileImageKey != null && !profileImageKey.isBlank()) {
                try {
                    imageUrl = s3Service.getFileUrl(profileImageKey);
                    // ë””ë²„ê¹… ë¡œê·¸
                    System.out.println("[UserServiceImpl.findAllUsers] userId: " + user.getId() + 
                                    ", profileImageKey: " + profileImageKey + 
                                    ", profileImageUrl: " + imageUrl.substring(0, Math.min(50, imageUrl.length())) + "...");
                } catch (Exception e) {
                    System.err.println("[UserServiceImpl.findAllUsers] S3 URL ë³€í™˜ ì‹¤íŒ¨: userId=" + user.getId() + 
                                   ", profileImageKey=" + profileImageKey + ", error=" + e.getMessage());
                    imageUrl = "";
                }
            }
            
            // profileImageUrlì„ í¬í•¨í•œ ìƒˆ DTO ë°˜í™˜
            return new UserDTO(
                dto.id(),
                dto.email(),
                dto.name(),
                dto.phone(),
                dto.role(),
                dto.status(),
                dto.deptId(),
                dto.deptName(),
                dto.joinDate(),
                dto.jobGrade(),
                profileImageKey,  // ì›ë³¸ profileImageKey ì‚¬ìš©
                imageUrl,          // ë³€í™˜ëœ S3 URL
                dto.employeeNumber()
            );
        })
        .toList();
}
```

**ê°œì„  ì‚¬í•­:**
- `findAll()` â†’ `findAllWithDepartment()`ë¡œ ë³€ê²½í•˜ì—¬ Departmentì™€ í•¨ê»˜ ë¡œë“œ
- `user.getProfileImageKey()`ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ S3 URLë¡œ ë³€í™˜
- ë³€í™˜ëœ URLì„ `profileImageUrl` í•„ë“œì— ì„¤ì •
- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¡œ ë¬¸ì œ ì¶”ì  ê°€ëŠ¥

##### 1.2 OrganizationUserResponseDTO ê°œì„ 
```java
// âœ… TO-BE: OrganizationUserResponseDTO
@Getter
@AllArgsConstructor
public class OrganizationUserResponseDTO {
    private Integer userId;
    private String name;
    private String deptName;
    private String positionName;
    private String email;
    private String profileImageUrl; // í”„ë¡œí•„ ì´ë¯¸ì§€ URL (S3 URL) ì¶”ê°€

    /**
     * User ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ëŠ” ì •ì  íŒ©í† ë¦¬ ë©”ì†Œë“œ (S3Service í¬í•¨ ë²„ì „)
     */
    public static OrganizationUserResponseDTO fromEntity(User user, S3Service s3Service) {
        if (user == null) return null;

        // ë¶€ì„œëª… ì„¤ì •
        String teamName = (user.getDepartment() != null) 
            ? user.getDepartment().getDeptName() : "N/A"; 

        // ì§ê¸‰ ì„¤ì •
        String positionName = (user.getJobGrade() != null) 
            ? user.getJobGrade().label() : "N/A";

        // í”„ë¡œí•„ ì´ë¯¸ì§€ URL ë³€í™˜ (user_profile_image_key â†’ S3 URL)
        String profileImageUrl = "";
        String profileImageKey = user.getProfileImageKey();
        
        if (profileImageKey != null && !profileImageKey.isBlank() && s3Service != null) {
            try {
                profileImageUrl = s3Service.getFileUrl(profileImageKey);
                System.out.println("[OrganizationUserResponseDTO.fromEntity] profileImageUrl ìƒì„± ì„±ê³µ: " + 
                                (profileImageUrl != null ? profileImageUrl.substring(0, Math.min(50, profileImageUrl.length())) + "..." : "null"));
            } catch (Exception e) {
                System.err.println("[OrganizationUserResponseDTO.fromEntity] S3 URL ë³€í™˜ ì‹¤íŒ¨: userId=" + user.getId() + 
                                 ", profileImageKey=" + profileImageKey + ", error=" + e.getMessage());
                profileImageUrl = "";
            }
        }

        return new OrganizationUserResponseDTO(
            user.getId(),
            user.getName(),
            teamName,
            positionName,
            user.getEmail(),
            profileImageUrl  // S3 URLë¡œ ë³€í™˜ëœ í”„ë¡œí•„ ì´ë¯¸ì§€ URL
        );
    }
}
```

**ê°œì„  ì‚¬í•­:**
- `profileImageUrl` í•„ë“œ ì¶”ê°€
- `fromEntity(User user, S3Service s3Service)` ë©”ì„œë“œ ì¶”ê°€
- `profileImageKey`ë¥¼ S3 URLë¡œ ë³€í™˜í•˜ì—¬ `profileImageUrl`ì— ì„¤ì •
- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

##### 1.3 UserServiceImpl.getOrganizationChart() ê°œì„ 
```java
// âœ… TO-BE: UserServiceImpl.getOrganizationChart()
@Override
@Transactional(readOnly = true)
public List<OrganizationUserResponseDTO> getOrganizationChart() {
    List<User> users = userRepository.findAllForOrganization();
    return users.stream()
        .map(user -> OrganizationUserResponseDTO.fromEntity(user, s3Service))  // S3Service ì „ë‹¬
        .collect(Collectors.toList());
}
```

**ê°œì„  ì‚¬í•­:**
- `OrganizationUserResponseDTO.fromEntity(user, s3Service)` í˜¸ì¶œ ì‹œ S3Service ì „ë‹¬

#### 2. í”„ë¡ íŠ¸ì—”ë“œ ê°œì„ 

##### 2.1 ChatRoomCreateDialog.jsx ê°œì„ 
```jsx
// âœ… TO-BE: ChatRoomCreateDialog.jsx
<ListItemAvatar>
  <Avatar
    src={user.profileImageUrl || undefined}  // ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  undefined ì‚¬ìš©
    sx={{ bgcolor: "#10c16d", width: 40, height: 40 }}
    imgProps={{
      onError: (e) => {
        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìˆ¨ê¸°ê³  ì´ë‹ˆì…œ í‘œì‹œ
        e.target.style.display = "none";
      }
    }}
  >
    {(!user.profileImageUrl || user.profileImageUrl.trim() === '') && 
      (user.name?.[0]?.toUpperCase() || "?")}
  </Avatar>
</ListItemAvatar>
```

**ê°œì„  ì‚¬í•­:**
- `user.profileImageUrl || undefined` ì‚¬ìš©í•˜ì—¬ ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  `undefined` ì „ë‹¬
- ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ `onError` í•¸ë“¤ëŸ¬ë¡œ ì´ë‹ˆì…œ í‘œì‹œ
- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¡œ ë°›ì€ ë°ì´í„° í™•ì¸ ê°€ëŠ¥

##### 2.2 ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
```jsx
// âœ… TO-BE: API ì‘ë‹µ ë°ì´í„° í™•ì¸ì„ ìœ„í•œ ë””ë²„ê¹… ë¡œê·¸
if (users.length > 0) {
  console.log("âœ… [ChatRoomCreateDialog] /user/organizationì—ì„œ ì‚¬ìš©ì ì¡°íšŒ ì„±ê³µ:", users.length);
  console.log("ğŸ” [ChatRoomCreateDialog] ì²« ë²ˆì§¸ ì‚¬ìš©ì ìƒ˜í”Œ:", {
    userId: users[0].userId,
    name: users[0].name,
    profileImageUrl: users[0].profileImageUrl,
    email: users[0].email
  });
}
```

**ê°œì„  ì‚¬í•­:**
- ê° API í˜¸ì¶œ í›„ ì²« ë²ˆì§¸ ì‚¬ìš©ì ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥
- í”„ë¡œí•„ ì´ë¯¸ì§€ URLì´ ì œëŒ€ë¡œ ì „ë‹¬ë˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

---

## ğŸ’¡ í•´ê²° ì´ìœ  ë° ê·¼ê±°

### 1. ì™œ `findAllWithDepartment()`ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?
- **ë¬¸ì œ**: `findAll()`ì„ ì‚¬ìš©í•˜ë©´ Departmentê°€ Lazy ë¡œë”©ë˜ì–´ íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì ‘ê·¼ ì‹œ `LazyInitializationException` ë°œìƒ ê°€ëŠ¥
- **í•´ê²°**: `findAllWithDepartment()`ë¥¼ ì‚¬ìš©í•˜ì—¬ `LEFT JOIN FETCH`ë¡œ Departmentë¥¼ í•¨ê»˜ ë¡œë“œ
- **íš¨ê³¼**: N+1 ë¬¸ì œ ë°©ì§€ ë° ì•ˆì •ì ì¸ ë°ì´í„° ì ‘ê·¼ ë³´ì¥

### 2. ì™œ `user.getProfileImageKey()`ë¥¼ ì§ì ‘ ì‚¬ìš©í–ˆëŠ”ê°€?
- **ë¬¸ì œ**: `UserDTO.toDTO()`ë¥¼ í†µí•´ ë³€í™˜í•˜ë©´ `profileImageUrl`ì´ `null`ë¡œ ì„¤ì •ë¨
- **í•´ê²°**: `user.getProfileImageKey()`ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ S3 URLë¡œ ë³€í™˜
- **íš¨ê³¼**: ì‹¤ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ í‚¤ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ S3 URL ìƒì„±

### 3. ì™œ `profileImageUrl || undefined`ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?
- **ë¬¸ì œ**: ë¹ˆ ë¬¸ìì—´(`""`)ì„ `src`ì— ì „ë‹¬í•˜ë©´ ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ì§€ ë¡œë“œë¥¼ ì‹œë„í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë°œìƒ
- **í•´ê²°**: `undefined`ë¥¼ ì „ë‹¬í•˜ì—¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ë¥¼ ë°©ì§€
- **íš¨ê³¼**: ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë°©ì§€ ë° ì„±ëŠ¥ ê°œì„ 

### 4. ì™œ ë””ë²„ê¹… ë¡œê·¸ë¥¼ ì¶”ê°€í–ˆëŠ”ê°€?
- **ë¬¸ì œ**: í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ” ì›ì¸ íŒŒì•…ì´ ì–´ë ¤ì›€
- **í•´ê²°**: ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œì— ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
- **íš¨ê³¼**: ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ ì›ì¸ íŒŒì•… ë° í•´ê²° ê°€ëŠ¥

---

## ğŸ“Š ê°œì„  íš¨ê³¼

### 1. ê¸°ëŠ¥ì  íš¨ê³¼
- âœ… ì±„íŒ…ë°© ìƒì„± íŒì—…ì—ì„œ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨
- âœ… ì‚¬ìš©ì ì‹ë³„ì´ ìš©ì´í•´ì ¸ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- âœ… ë‹¤ë¥¸ í™”ë©´ê³¼ì˜ UI ì¼ê´€ì„± í™•ë³´

### 2. ê¸°ìˆ ì  íš¨ê³¼
- âœ… N+1 ë¬¸ì œ ë°©ì§€: `findAllWithDepartment()` ì‚¬ìš©ìœ¼ë¡œ íš¨ìœ¨ì ì¸ ë°ì´í„° ë¡œë”©
- âœ… ì•ˆì •ì„± í–¥ìƒ: LazyInitializationException ë°©ì§€
- âœ… ì„±ëŠ¥ ê°œì„ : ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ ë°©ì§€
- âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ: ë””ë²„ê¹… ë¡œê·¸ë¡œ ë¬¸ì œ ì¶”ì  ìš©ì´

### 3. ì‚¬ìš©ì ê²½í—˜ íš¨ê³¼
- âœ… ì‹œê°ì  ì‹ë³„ì„± í–¥ìƒ: í”„ë¡œí•„ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ì ì‹ë³„ì´ ì‰¬ì›Œì§
- âœ… ì¼ê´€ëœ UI: ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë™ì¼í•œ í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ ë°©ì‹
- âœ… ì§ê´€ì ì¸ ì¸í„°í˜ì´ìŠ¤: ì´ë¯¸ì§€ì™€ ì´ë‹ˆì…œì„ í•¨ê»˜ í‘œì‹œí•˜ì—¬ ì‚¬ìš©ì ì¸ì‹ë„ í–¥ìƒ

---

## ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ
- **ë°±ì—”ë“œ**: Spring Boot, JPA, S3Service
- **í”„ë¡ íŠ¸ì—”ë“œ**: React, Material-UI
- **ë°ì´í„°ë² ì´ìŠ¤**: MySQL (user_profile_image_key ì»¬ëŸ¼)
- **ìŠ¤í† ë¦¬ì§€**: AWS S3

---

## ğŸ“ ê²°ë¡ 
ì±„íŒ…ë°© ìƒì„± íŒì—…ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ì „ë°˜ì ìœ¼ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ `user_profile_image_key`ë¥¼ S3 URLë¡œ ë³€í™˜í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì— ì „ë‹¬í•˜ëŠ” ê³¼ì •ì„ êµ¬í˜„í•˜ê³ , ë°ì´í„° ë¡œë”© ìµœì í™”ì™€ ë””ë²„ê¹… ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ì•ˆì •ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•˜ê³  ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ UI ì¼ê´€ì„±ì„ í™•ë³´í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

