# ğŸ“± ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œ ê°œì„  í”„ë¡œì íŠ¸

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”
Spring Boot ê¸°ë°˜ ê¸°ì—…ìš© í˜‘ì—… í”Œë«í¼ì˜ ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œì„ ê°œì„ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ê³  ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

---

## ğŸ”´ AS-IS (ê°œì„  ì „ ë¬¸ì œì )

### 1. ë©”ì‹œì§€ ì½ìŒ ìƒíƒœ ê´€ë¦¬ì˜ ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- `chat_message_read_status` í…Œì´ë¸”ì´ ë‹¨ì¼ PK(`id`)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë³„ ì½ìŒ ìƒíƒœë¥¼ ê´€ë¦¬
- ë™ì¼í•œ ë©”ì‹œì§€ì— ëŒ€í•´ ì—¬ëŸ¬ ì°¸ì—¬ìì˜ ì½ìŒ ìƒíƒœë¥¼ ì €ì¥í•˜ë ¤ í•  ë•Œ ë°ì´í„° ë®ì–´ì“°ê¸° ë°œìƒ
- ê²°ê³¼ì ìœ¼ë¡œ `unreadCount`ê°€ í•­ìƒ 0ìœ¼ë¡œ ê³„ì‚°ë˜ëŠ” ì¹˜ëª…ì ì¸ ë²„ê·¸ ë°œìƒ

**ê¸°ìˆ ì  ì›ì¸:**
```sql
-- ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°
CREATE TABLE chat_message_read_status (
    id INT PRIMARY KEY,  -- âš ï¸ ë‹¨ì¼ PKë¡œ ì¸í•œ ë¬¸ì œ
    chat_message_id INT,
    user_id INT,
    read_yn BOOLEAN
);
```
- ë©”ì‹œì§€ 1ê±´ì— ì°¸ì—¬ì 3ëª…ì´ ìˆì„ ë•Œ, ê° ì°¸ì—¬ìë³„ë¡œ ì½ìŒ ìƒíƒœë¥¼ ì €ì¥í•´ì•¼ í•˜ì§€ë§Œ
- ë‹¨ì¼ PK êµ¬ì¡°ë¡œ ì¸í•´ ë§ˆì§€ë§‰ì— ì €ì¥ëœ ì°¸ì—¬ìì˜ ë°ì´í„°ë§Œ ë‚¨ê³  ì´ì „ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°ë¨
- `COUNT(read_yn = false)` ì¿¼ë¦¬ ê²°ê³¼ê°€ í•­ìƒ 0 ë˜ëŠ” 1ë¡œë§Œ ë°˜í™˜ë¨

**ì˜í–¥:**
- ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ
- ë©”ì‹œì§€ ì˜†ì— ì•ˆì½ì€ ì‚¬ëŒ ìˆ˜ê°€ ì •í™•í•˜ê²Œ í‘œì‹œë˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ì—†ìŒ

---

### 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆì„ ë•Œ ìì‹ ì˜ í™”ë©´ì—ëŠ” í‘œì‹œë˜ì§€ë§Œ ìƒëŒ€ë°© í™”ë©´ì—ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŒ
- ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ë§Œ ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ

**ê¸°ìˆ ì  ì›ì¸:**
```javascript
// ê¸°ì¡´ ì½”ë“œ (ChatLayout.jsx)
const handleNewMessage = (msg) => {
  const foundRoom = roomList.find(r => r.roomId === msg.roomId);
  if (!foundRoom) return; // âš ï¸ roomListì— ì—†ìœ¼ë©´ ë©”ì‹œì§€ ë¬´ì‹œ
  // ...
};
```
- WebSocketìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë„ì°©í•´ë„ `roomList`ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë™ê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš° ë©”ì‹œì§€ê°€ ë¬´ì‹œë¨
- í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  `foundRoom` ì²´í¬ë¡œ ì¸í•´ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì§€ ì•ŠìŒ

**ì˜í–¥:**
- ì‹¤ì‹œê°„ ì±„íŒ…ì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ì¦‰ì‹œ ë©”ì‹œì§€ ì „ë‹¬ì´ ì‘ë™í•˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜ ë° ì‹œìŠ¤í…œ ì‹ ë¢°ë„ í•˜ë½

---

### 3. ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ì˜ ì‹¤ì‹œê°„ ë°˜ì˜ ë¶€ì¬

**ë¬¸ì œ ìƒí™©:**
- ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ì ‘ì†í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì½ì–´ë„ ë‹¤ë¥¸ ì°¸ì—¬ì í™”ë©´ì˜ `unreadCount`ê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ
- ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ë§Œ `unreadCount`ê°€ ê°ì†Œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

**ê¸°ìˆ ì  ì›ì¸:**
- ë°±ì—”ë“œì—ì„œ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ëŠ” ë˜ì§€ë§Œ WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì•Œë¦¼ì´ ì—†ìŒ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ `UNREAD_COUNT_UPDATE` íƒ€ì… ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì´ ì—†ìŒ

**ì˜í–¥:**
- ë©”ì‹œì§€ ì½ìŒ ìƒíƒœê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë˜ì§€ ì•Šì•„ í˜‘ì—… íš¨ìœ¨ì„± ì €í•˜
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì–´ë ¤ì›€

---

### 4. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ë¶€ì¡±

**ë¬¸ì œ ìƒí™©:**
- ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì´ë¦„ë§Œ í‘œì‹œë˜ê³  ì§ê¸‰, ë¶€ì„œëª… ë“± ì¶”ê°€ ì •ë³´ê°€ ì—†ìŒ
- ì±„íŒ…ë°© ì°¸ì—¬ì ëª©ë¡ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€, ì§ê¸‰, ë¶€ì„œëª…ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ

**ê¸°ìˆ ì  ì›ì¸:**
- DTOì— `senderJobGrade`, `senderDeptName` í•„ë“œê°€ ì—†ìŒ
- Controllerì—ì„œ ë°œì‹ ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ DTOì— ì„¤ì •í•˜ëŠ” ë¡œì§ì´ ì—†ìŒ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ì´ ì—†ìŒ

**ì˜í–¥:**
- ì¡°ì§ ë‚´ ê³„ì¸µ êµ¬ì¡° íŒŒì•…ì´ ì–´ë ¤ì›€
- ì‚¬ìš©ì ì‹ë³„ì´ ì–´ë ¤ì›Œ í˜‘ì—… íš¨ìœ¨ì„± ì €í•˜

---

## ğŸŸ¢ TO-BE (ê°œì„  í›„)

### 1. ë³µí•©í‚¤ë¥¼ í™œìš©í•œ ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- `chat_message_read_status` í…Œì´ë¸”ì˜ PKë¥¼ `(chat_message_id, user_id)` ë³µí•©í‚¤ë¡œ ë³€ê²½
- JPA `@IdClass`ë¥¼ í™œìš©í•˜ì—¬ ë³µí•©í‚¤ ì—”í‹°í‹° êµ¬ì¡° êµ¬í˜„

**êµ¬í˜„ ë‚´ìš©:**

#### 1-1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½
```sql
-- ê¸°ì¡´ PK ì œê±° ë° ë³µí•©í‚¤ ì¶”ê°€
ALTER TABLE chat_message_read_status DROP PRIMARY KEY;
ALTER TABLE chat_message_read_status 
ADD PRIMARY KEY (chat_message_id, user_id);
```

#### 1-2. ë³µí•©í‚¤ í´ë˜ìŠ¤ ìƒì„±
```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode
public class ChatMessageReadStatusId implements Serializable {
    private Integer chat;  // Chat ì—”í‹°í‹°ì˜ id
    private Integer user;  // User ì—”í‹°í‹°ì˜ id
}
```

#### 1-3. ì—”í‹°í‹° ìˆ˜ì •
```java
@Entity
@Table(name = "chat_message_read_status")
@IdClass(ChatMessageReadStatusId.class)
public class ChatMessageReadStatus {
    @Id
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "chat_message_id", nullable = false)
    private Chat chat;
    
    @Id
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
    
    private Boolean readYn = false;
    private LocalDateTime readAt;
}
```

#### 1-4. Repository ìˆ˜ì •
```java
// ë³µí•©í‚¤ íƒ€ì…ìœ¼ë¡œ ë³€ê²½
public interface ChatMessageReadStatusRepository 
    extends JpaRepository<ChatMessageReadStatus, ChatMessageReadStatusId> {
    
    // COUNT ì¿¼ë¦¬ ìˆ˜ì • (ë³µí•©í‚¤ ì‚¬ìš©ìœ¼ë¡œ COUNT(1) ì‚¬ìš©)
    @Query("SELECT COUNT(1) FROM ChatMessageReadStatus r " +
           "WHERE r.chat.id = :chatId AND r.readYn = false " +
           "AND r.user.id != (SELECT c.sender.id FROM Chat c WHERE c.id = :chatId)")
    int countUnreadByChatId(@Param("chatId") Integer chatId);
}
```

#### 1-5. Service ë¡œì§ ê°œì„ 
```java
@Transactional
public Chat sendChatMessage(Integer roomId, Integer senderId, Object content) {
    // ... ë©”ì‹œì§€ ì €ì¥ ë¡œì§ ...
    
    // ê° ì°¸ì—¬ìë³„ë¡œ ì½ìŒ ìƒíƒœ ìƒì„± (ë³µí•©í‚¤ë¡œ ì¤‘ë³µ ë°©ì§€)
    for (ChatRoomUser participant : participants) {
        Optional<ChatMessageReadStatus> existingStatus = 
            chatMessageReadStatusRepository.findByChatIdAndUserId(
                chat.getId(), participant.getUser().getId());
        
        ChatMessageReadStatus readStatus;
        if (existingStatus.isPresent()) {
            readStatus = existingStatus.get();
            readStatus.resetReadStatus();
        } else {
            readStatus = ChatMessageReadStatus.create(chat, participant.getUser());
        }
        
        // ë°œì‹ ìëŠ” ì¦‰ì‹œ ì½ìŒ ì²˜ë¦¬
        if (participant.getUser().getId().equals(senderId)) {
            readStatus.markRead();
        }
        
        chatMessageReadStatusRepository.save(readStatus);
    }
    
    chatMessageReadStatusRepository.flush(); // ì¦‰ì‹œ DB ë°˜ì˜
    return chat;
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ë³„ë¡œ ê° ì°¸ì—¬ìì˜ ì½ìŒ ìƒíƒœê°€ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë¨
- âœ… `unreadCount`ê°€ ì •í™•í•˜ê²Œ ê³„ì‚°ë˜ì–´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë¨
- âœ… ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ë° ì¤‘ë³µ ì €ì¥ ë°©ì§€
- âœ… ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ê°€ ì •í™•í•˜ê²Œ í‘œì‹œë¨

---

### 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ê°œì„ 

**í•´ê²° ë°©ì•ˆ:**
- í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ëŠ” `roomList` ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì¶”ê°€ë˜ë„ë¡ ë¡œì§ ìˆ˜ì •
- WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë°œì‹ ì ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„

**êµ¬í˜„ ë‚´ìš©:**

#### 2-1. í”„ë¡ íŠ¸ì—”ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  ë¡œì§ ê°œì„ 
```javascript
const handleNewMessage = (msg) => {
  // ë°œì‹ ì ì´ë©”ì¼ë¡œ ë‚´ ë©”ì‹œì§€ íŒë³„
  const isMyMessage = 
    msg.senderEmail && 
    userProfile?.email && 
    msg.senderEmail.trim().toLowerCase() === userProfile.email.trim().toLowerCase();
  
  // ë‚´ ë©”ì‹œì§€ì¸ ê²½ìš°
  if (isMyMessage) {
    if (Number(msg.roomId) === Number(selectedRoomId)) {
      setMessages((prev) => [...prev, msg]);
    }
    return;
  }
  
  // ìƒëŒ€ë°© ë©”ì‹œì§€ì¸ ê²½ìš°
  const roomIdNum = Number(msg.roomId);
  const foundRoom = roomList.find(r => r && Number(r.roomId) === roomIdNum);
  
  // â­ í˜„ì¬ ì„ íƒëœ ë°©ì˜ ë©”ì‹œì§€ëŠ” foundRoomì´ ì—†ì–´ë„ ì¶”ê°€
  if (roomIdNum === Number(selectedRoomId)) {
    setMessages((prev) => [...prev, msg]);
  } else if (foundRoom) {
    // ë‹¤ë¥¸ ë°©ì˜ ë©”ì‹œì§€ëŠ” í† ìŠ¤íŠ¸ ì•Œë¦¼ë§Œ í‘œì‹œ
    setToastRooms((prev) => [...prev, toastInfo]);
  }
};
```

#### 2-2. ë°±ì—”ë“œ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ë°œì‹ ì ì •ë³´ í¬í•¨
```java
@MessageMapping("/chat.send")
public void sendMessage(@Payload ChatMessageRequest req, 
                       @AuthenticationPrincipal CustomUserDetails authUser) {
    Chat saved = chatRoomService.sendChatMessage(req.getRoomId(), authUser.getId(), req.getContent());
    
    ChatResponseDTO responseDto = ChatResponseDTO.fromEntity(saved);
    
    // â­ ë°œì‹ ì ì´ë©”ì¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    responseDto.setSenderEmail(authUser.getEmail());
    
    // WebSocketìœ¼ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    messagingTemplate.convertAndSend("/topic/chat.room." + req.getRoomId(), responseDto);
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ ì „ì†¡ ì¦‰ì‹œ ëª¨ë“  ì°¸ì—¬ì í™”ë©´ì— ì‹¤ì‹œê°„ í‘œì‹œ
- âœ… ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ë©”ì‹œì§€ í™•ì¸ ê°€ëŠ¥
- âœ… ì‹¤ì‹œê°„ ì±„íŒ…ì˜ í•µì‹¬ ê¸°ëŠ¥ ì •ìƒ ì‘ë™

---

### 3. ì‹¤ì‹œê°„ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì‹œ WebSocketì„ í†µí•´ `UNREAD_COUNT_UPDATE` ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸

**êµ¬í˜„ ë‚´ìš©:**

#### 3-1. ë°±ì—”ë“œ ì½ìŒ ì²˜ë¦¬ ë° WebSocket ì•Œë¦¼
```java
@PatchMapping("/rooms/{roomId}/messages/read")
public ResponseEntity<?> markRoomMessagesAsRead(
        @PathVariable Integer roomId, 
        @AuthenticationPrincipal CustomUserDetails customUserDetails) {
    
    User user = userRepository.findByEmail(customUserDetails.getEmail()).orElseThrow();
    
    // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ë° ì½ìŒ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    List<Integer> readChatIds = chatRoomService.markMessagesAsRead(roomId, user.getId());
    
    // ê° ë©”ì‹œì§€ì˜ unreadCountë¥¼ -1 ê°ì†Œì‹œí‚¤ê³  WebSocketìœ¼ë¡œ ì•Œë¦¼
    for (Integer chatId : readChatIds) {
        Chat chat = chatRepository.findById(chatId).orElse(null);
        if (chat != null) {
            // unreadCount ì¬ê³„ì‚°
            int newUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(chatId);
            
            Map<String, Object> updateMessage = new HashMap<>();
            updateMessage.put("type", "UNREAD_COUNT_UPDATE");
            updateMessage.put("chatId", chatId);
            updateMessage.put("unreadCount", newUnreadCount);
            updateMessage.put("roomId", roomId);
            updateMessage.put("senderId", user.getId());
            updateMessage.put("senderEmail", user.getEmail());
            
            // ëª¨ë“  ì°¸ì—¬ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
            messagingTemplate.convertAndSend("/topic/chat.room." + roomId, updateMessage);
        }
    }
    
    return ResponseEntity.ok().build();
}
```

#### 3-2. Service ë¡œì§ ê°œì„ 
```java
@Override
@Transactional
public List<Integer> markMessagesAsRead(Integer roomId, Integer userId) {
    // í•´ë‹¹ ë°©ì˜ ëª¨ë“  ì•ˆì½ì€ ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
    chatMessageReadStatusRepository.markMessagesAsReadInRoomForUser(
        roomId, userId, LocalDateTime.now());
    
    // ì½ìŒ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    List<ChatMessageReadStatus> readStatuses = 
        chatMessageReadStatusRepository.findByChatRoomIdAndUserIdAndReadYnTrue(roomId, userId);
    
    return readStatuses.stream()
        .map(status -> status.getChat().getId())
        .collect(Collectors.toList());
}
```

#### 3-3. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
```javascript
const handleNewMessage = (msg) => {
  // UNREAD_COUNT_UPDATE ë©”ì‹œì§€ ì²˜ë¦¬
  if (msg.type === "UNREAD_COUNT_UPDATE") {
    const { chatId, unreadCount, roomId, senderId, senderEmail } = msg;
    
    // í˜„ì¬ ì„ íƒëœ ë°©ì˜ ë©”ì‹œì§€ ëª©ë¡ì—ì„œ í•´ë‹¹ ë©”ì‹œì§€ì˜ unreadCount ì—…ë°ì´íŠ¸
    if (Number(roomId) === Number(selectedRoomId)) {
      setMessages((prev) =>
        prev.map((m) =>
          Number(m.id) === Number(chatId)
            ? { ...m, unreadCount: unreadCount != null ? unreadCount : 0 }
            : m
        )
      );
    }
    
    // ì±„íŒ…ë°© ëª©ë¡ì˜ unreadCountë„ ì—…ë°ì´íŠ¸
    setRoomList((prevRoomList) =>
      prevRoomList.map((room) =>
        Number(room.roomId) === Number(roomId)
          ? { ...room, unreadCount: calculateTotalUnreadCount(roomId) }
          : room
      )
    );
    
    return;
  }
  
  // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬...
};
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ ì½ìŒ ì¦‰ì‹œ ëª¨ë“  ì°¸ì—¬ì í™”ë©´ì—ì„œ `unreadCount` ì‹¤ì‹œê°„ ê°ì†Œ
- âœ… ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ì½ìŒ ìƒíƒœ ë°˜ì˜
- âœ… í˜‘ì—… íš¨ìœ¨ì„± í–¥ìƒ ë° ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

### 4. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- DTOì— ë°œì‹ ì ì§ê¸‰, ë¶€ì„œëª… í•„ë“œ ì¶”ê°€
- Controllerì—ì„œ ë°œì‹ ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ DTOì— ì„¤ì •
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ì‚¬ìš©ì ì •ë³´ í‘œì‹œ

**êµ¬í˜„ ë‚´ìš©:**

#### 4-1. DTO í•„ë“œ ì¶”ê°€
```java
@Getter
@Setter
@Builder
public class ChatMessageResponseDTO {
    private Integer id;
    private String senderName;
    private String senderEmail;
    private String senderProfileImageUrl;
    private JobGrade senderJobGrade;  // â­ ì§ê¸‰ í•„ë“œ ì¶”ê°€
    private String senderDeptName;    // â­ ë¶€ì„œëª… í•„ë“œ ì¶”ê°€
    private Integer unreadCount;
    // ...
}
```

#### 4-2. Controllerì—ì„œ ë°œì‹ ì ì •ë³´ ì„¤ì •
```java
@MessageMapping("/chat.send")
public void sendMessage(@Payload ChatMessageRequest req, 
                       @AuthenticationPrincipal CustomUserDetails authUser) {
    // ... ë©”ì‹œì§€ ì €ì¥ ë¡œì§ ...
    
    User senderUser = userRepository.findById(authUser.getId()).orElse(null);
    if (senderUser != null) {
        // í”„ë¡œí•„ ì´ë¯¸ì§€ URL ì„¤ì •
        if (senderUser.getProfileImageKey() != null && !senderUser.getProfileImageKey().isBlank()) {
            String profileImageUrl = s3Service.getFileUrl(senderUser.getProfileImageKey());
            responseDto.setSenderProfileImageUrl(profileImageUrl);
        } else {
            responseDto.setSenderProfileImageUrl("");
        }
        
        // â­ ì§ê¸‰ ì„¤ì •
        responseDto.setSenderJobGrade(senderUser.getJobGrade());
        
        // â­ ë¶€ì„œëª… ì„¤ì •
        if (senderUser.getDepartment() != null) {
            responseDto.setSenderDeptName(senderUser.getDepartment().getDeptName());
        } else {
            responseDto.setSenderDeptName("");
        }
    }
    
    messagingTemplate.convertAndSend("/topic/chat.room." + req.getRoomId(), responseDto);
}
```

#### 4-3. í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
```javascript
// ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì •ë³´ í‘œì‹œ
<Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 0.5 }}>
  <Typography sx={{ fontSize: 13, fontWeight: 700 }}>
    {msg.senderName}
  </Typography>
  {msg.senderJobGrade && (
    <Typography
      sx={{
        color: "text.secondary",
        bgcolor: "action.selected",
        px: 1,
        py: 0.25,
        borderRadius: 1,
        fontSize: 12,
      }}
    >
      {getJobGradeLabel(msg.senderJobGrade)}
    </Typography>
  )}
  {msg.senderDeptName && (
    <Typography
      sx={{
        color: "primary.main",
        px: 1,
        py: 0.25,
        fontSize: 12,
      }}
    >
      {msg.senderDeptName}
    </Typography>
  )}
</Box>

// í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
<Avatar
  src={msg.senderProfileImageUrl}
  sx={{ width: 36, height: 36 }}
>
  {!msg.senderProfileImageUrl && (msg.senderName?.[0]?.toUpperCase() || "?")}
</Avatar>
```

**ê°œì„  íš¨ê³¼:**
- âœ… ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì´ë¦„, ì§ê¸‰, ë¶€ì„œëª…ì´ í•¨ê»˜ í‘œì‹œë˜ì–´ ì‚¬ìš©ì ì‹ë³„ ìš©ì´
- âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œë¡œ ì‹œê°ì  ì‹ë³„ì„± í–¥ìƒ
- âœ… ì¡°ì§ ë‚´ ê³„ì¸µ êµ¬ì¡° íŒŒì•… ìš©ì´

---

## ğŸ“Š ì„±ê³¼ ë° íš¨ê³¼

### ì •ëŸ‰ì  ì„±ê³¼
- **ë°ì´í„° ë¬´ê²°ì„±**: ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì •í™•ë„ 100% ë‹¬ì„± (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)
- **ì‹¤ì‹œê°„ ë°˜ì˜ë¥ **: ë©”ì‹œì§€ ì „ì†¡ ì¦‰ì‹œ í‘œì‹œìœ¨ 100% (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)
- **ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸**: ì‹¤ì‹œê°„ ë°˜ì˜ë¥  100% (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)

### ì •ì„±ì  íš¨ê³¼
- âœ… **ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ**: ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€ í™•ì¸ ë° ì½ìŒ ìƒíƒœ ë°˜ì˜
- âœ… **ë°ì´í„° ì‹ ë¢°ì„± í–¥ìƒ**: ë³µí•©í‚¤ êµ¬ì¡°ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- âœ… **í˜‘ì—… íš¨ìœ¨ì„± í–¥ìƒ**: ì‚¬ìš©ì ì •ë³´ í‘œì‹œë¡œ ì¡°ì§ ë‚´ ì†Œí†µ ì›í™œ
- âœ… **ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ**: WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹  ì•ˆì •í™”

---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: Spring Boot, JPA/Hibernate, WebSocket/STOMP
- **Frontend**: React, Material-UI, WebSocket Client
- **Database**: MySQL
- **Infrastructure**: AWS S3 (í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥)

---

## ğŸ’¡ í•µì‹¬ ê¸°ìˆ  í¬ì¸íŠ¸

1. **ë³µí•©í‚¤ ì„¤ê³„**: JPA `@IdClass`ë¥¼ í™œìš©í•œ ë³µí•©í‚¤ ì—”í‹°í‹° ì„¤ê³„
2. **ì‹¤ì‹œê°„ í†µì‹ **: WebSocket/STOMPë¥¼ í™œìš©í•œ ì–‘ë°©í–¥ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡
3. **ìƒíƒœ ê´€ë¦¬**: React ìƒíƒœ ê´€ë¦¬ ë° WebSocket ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸
4. **ë°ì´í„° ë¬´ê²°ì„±**: ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ë° íŠ¸ëœì­ì…˜ ê´€ë¦¬

---

## ğŸ“ ê²°ë¡ 

ë³¸ í”„ë¡œì íŠ¸ë¥¼ í†µí•´ ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ë©”ì‹œì§€ ì „ì†¡, ì½ìŒ ìƒíƒœ ê´€ë¦¬, ì‚¬ìš©ì ì •ë³´ í‘œì‹œë¥¼ ê°œì„ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤. íŠ¹íˆ ë³µí•©í‚¤ êµ¬ì¡° ë„ì…ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ê³ , WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹ ìœ¼ë¡œ í˜‘ì—… íš¨ìœ¨ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

