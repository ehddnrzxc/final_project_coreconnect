# ğŸ“± ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œ ê°œì„  í”„ë¡œì íŠ¸

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”
Spring Boot ê¸°ë°˜ ê¸°ì—…ìš© í˜‘ì—… í”Œë«í¼ì˜ ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œì„ ê°œì„ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ê³  ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤. ë³µí•©í‚¤ ì„¤ê³„, ì‹¤ì‹œê°„ í†µì‹ , ìƒíƒœ ê´€ë¦¬ ë“± í•µì‹¬ ê¸°ìˆ ì„ ì ìš©í•˜ì—¬ ì•ˆì •ì ì´ê³  í™•ì¥ ê°€ëŠ¥í•œ ì±„íŒ… ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ”´ AS-IS (ê°œì„  ì „ ë¬¸ì œì )

### 1. ë©”ì‹œì§€ ì½ìŒ ìƒíƒœ ê´€ë¦¬ì˜ ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- `chat_message_read_status` í…Œì´ë¸”ì´ ë‹¨ì¼ PK(`id`)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë³„ ì½ìŒ ìƒíƒœë¥¼ ê´€ë¦¬
- ë™ì¼í•œ ë©”ì‹œì§€ì— ëŒ€í•´ ì—¬ëŸ¬ ì°¸ì—¬ìì˜ ì½ìŒ ìƒíƒœë¥¼ ì €ì¥í•˜ë ¤ í•  ë•Œ ë°ì´í„° ë®ì–´ì“°ê¸° ë°œìƒ
- ê²°ê³¼ì ìœ¼ë¡œ `unreadCount`ê°€ í•­ìƒ 0ìœ¼ë¡œ ê³„ì‚°ë˜ëŠ” ì¹˜ëª…ì ì¸ ë²„ê·¸ ë°œìƒ

**ê¸°ìˆ ì  ì›ì¸:**
```sql
-- ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°
CREATE TABLE chat_message_read_status (
    id INT PRIMARY KEY,  -- âš ï¸ ë‹¨ì¼ PKë¡œ ì¸í•œ ë¬¸ì œ
    chat_message_id INT,
    user_id INT,
    read_yn BOOLEAN
);
```
- ë©”ì‹œì§€ 1ê±´ì— ì°¸ì—¬ì 3ëª…ì´ ìˆì„ ë•Œ, ê° ì°¸ì—¬ìë³„ë¡œ ì½ìŒ ìƒíƒœë¥¼ ì €ì¥í•´ì•¼ í•˜ì§€ë§Œ
- ë‹¨ì¼ PK êµ¬ì¡°ë¡œ ì¸í•´ ë§ˆì§€ë§‰ì— ì €ì¥ëœ ì°¸ì—¬ìì˜ ë°ì´í„°ë§Œ ë‚¨ê³  ì´ì „ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°ë¨
- `COUNT(read_yn = false)` ì¿¼ë¦¬ ê²°ê³¼ê°€ í•­ìƒ 0 ë˜ëŠ” 1ë¡œë§Œ ë°˜í™˜ë¨
- JPQL ì¿¼ë¦¬ì—ì„œ `COUNT(r.id)`ë¥¼ ì‚¬ìš©í•˜ë ¤ í–ˆìœ¼ë‚˜ ë³µí•©í‚¤ë¡œ ë³€ê²½ í›„ `id` í•„ë“œê°€ ì—†ì–´ì ¸ `Unknown column` ì—ëŸ¬ ë°œìƒ

**ì˜í–¥:**
- ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ
- ë©”ì‹œì§€ ì˜†ì— ì•ˆì½ì€ ì‚¬ëŒ ìˆ˜ê°€ ì •í™•í•˜ê²Œ í‘œì‹œë˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ì—†ìŒ
- ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ë° ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥ ìì²´ê°€ ë™ì‘í•˜ì§€ ì•ŠìŒ

**í•´ê²° ë°©ë²•:**
1. **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë¶„ì„ ë° ì„¤ê³„ ë³€ê²½**
   - ê¸°ì¡´ ë‹¨ì¼ PK êµ¬ì¡°ì˜ ë¬¸ì œì  íŒŒì•…
   - ë³µí•©í‚¤ `(chat_message_id, user_id)` ì„¤ê³„ë¡œ ë³€ê²½ ê²°ì •
   - Foreign Key ì œì•½ ì¡°ê±´ ì¬ì„¤ì •

2. **JPA ì—”í‹°í‹° êµ¬ì¡° ê°œì„ **
   - `@IdClass` ì–´ë…¸í…Œì´ì…˜ì„ í™œìš©í•œ ë³µí•©í‚¤ ì—”í‹°í‹° êµ¬í˜„
   - `ChatMessageReadStatusId` í´ë˜ìŠ¤ ìƒì„± (Serializable êµ¬í˜„ í•„ìˆ˜)
   - ì—”í‹°í‹°ì—ì„œ `id` í•„ë“œ ì œê±° ë° ë³µí•©í‚¤ í•„ë“œ ì„¤ì •

3. **Repository ì¿¼ë¦¬ ìˆ˜ì •**
   - ëª¨ë“  `COUNT(r.id)` ë˜ëŠ” `COUNT(c)` ì¿¼ë¦¬ë¥¼ `COUNT(1)`ë¡œ ë³€ê²½
   - ë³µí•©í‚¤ ê¸°ë°˜ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€ (`findByChatIdAndUserId`)
   - JPQL ì¿¼ë¦¬ì—ì„œ ë³µí•©í‚¤ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •

4. **Service ë¡œì§ ê°œì„ **
   - ì°¸ì—¬ìë³„ ì½ìŒ ìƒíƒœ ìƒì„± ì‹œ ë³µí•©í‚¤ë¡œ ì¤‘ë³µ ë°©ì§€
   - ê¸°ì¡´ row ì¬ì‚¬ìš© ë¡œì§ ì¶”ê°€ (`resetReadStatus` ë©”ì„œë“œ í™œìš©)
   - `flush()` í˜¸ì¶œë¡œ ì¦‰ì‹œ DB ë°˜ì˜ í›„ `unreadCount` ì¬ê³„ì‚°

5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ì—¬ëŸ¬ ì°¸ì—¬ìê°€ ìˆëŠ” ì±„íŒ…ë°©ì—ì„œ ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸
   - DBì—ì„œ ì‹¤ì œ row ìˆ˜ í™•ì¸ (ì°¸ì—¬ì ìˆ˜ì™€ ì¼ì¹˜ ì—¬ë¶€)
   - `unreadCount` ê³„ì‚° ì •í™•ë„ ê²€ì¦

---

### 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆì„ ë•Œ ìì‹ ì˜ í™”ë©´ì—ëŠ” í‘œì‹œë˜ì§€ë§Œ ìƒëŒ€ë°© í™”ë©´ì—ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŒ
- ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ë§Œ ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ
- Optimistic UI Updateë¡œ ì¸í•´ ì„ì‹œ ë©”ì‹œì§€(`temp-` ì ‘ë‘ì‚¬)ê°€ í™”ë©´ì— í‘œì‹œë¨

**ê¸°ìˆ ì  ì›ì¸:**
```javascript
// ê¸°ì¡´ ì½”ë“œ (ChatLayout.jsx)
const handleNewMessage = (msg) => {
  const foundRoom = roomList.find(r => r.roomId === msg.roomId);
  if (!foundRoom) return; // âš ï¸ roomListì— ì—†ìœ¼ë©´ ë©”ì‹œì§€ ë¬´ì‹œ
  // ...
};

// Optimistic UI Updateë¡œ ì¸í•œ ì„ì‹œ ë©”ì‹œì§€ ìƒì„±
const tempMessage = {
  id: `temp-${Date.now()}`,
  content: message,
  // ...
};
setMessages(prev => [...prev, tempMessage]); // âš ï¸ ì„œë²„ ì‘ë‹µ ì „ ì„ì‹œ ë©”ì‹œì§€ ì¶”ê°€
```
- WebSocketìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë„ì°©í•´ë„ `roomList`ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë™ê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš° ë©”ì‹œì§€ê°€ ë¬´ì‹œë¨
- í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  `foundRoom` ì²´í¬ë¡œ ì¸í•´ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì§€ ì•ŠìŒ
- ì„œë²„ ì‘ë‹µ ì „ ì„ì‹œ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ì—¬ ì‹¤ì œ ë©”ì‹œì§€ì™€ í˜¼ë™ ë°œìƒ

**ì˜í–¥:**
- ì‹¤ì‹œê°„ ì±„íŒ…ì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ì¦‰ì‹œ ë©”ì‹œì§€ ì „ë‹¬ì´ ì‘ë™í•˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜ ë° ì‹œìŠ¤í…œ ì‹ ë¢°ë„ í•˜ë½
- ì„ì‹œ ë©”ì‹œì§€ì™€ ì‹¤ì œ ë©”ì‹œì§€ê°€ í˜¼ì¬ë˜ì–´ UI í˜¼ë€ ë°œìƒ

**í•´ê²° ë°©ë²•:**
1. **í”„ë¡ íŠ¸ì—”ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  ë¡œì§ ê°œì„ **
   - `foundRoom` ì²´í¬ ì œê±°: í˜„ì¬ ì„ íƒëœ ë°©ì˜ ë©”ì‹œì§€ëŠ” `roomList` ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì¶”ê°€
   - ë°œì‹ ì ì´ë©”ì¼ ê¸°ë°˜ ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„ ë¡œì§ ì¶”ê°€
   - ì¤‘ë³µ ë©”ì‹œì§€ ì²´í¬ ë¡œì§ ì¶”ê°€ (`prev.some()` í™œìš©)

2. **Optimistic UI Update ì œê±°**
   - ì„ì‹œ ë©”ì‹œì§€(`temp-` ì ‘ë‘ì‚¬) ìƒì„± ë¡œì§ ì™„ì „ ì œê±°
   - ì„œë²„ì—ì„œ WebSocketìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ë§Œ UIì— í‘œì‹œ
   - ì‚¬ìš©ì ì…ë ¥ì°½ì€ ì¦‰ì‹œ ë¹„ìš°ë˜, ë©”ì‹œì§€ëŠ” ì„œë²„ ì‘ë‹µ í›„ì—ë§Œ í‘œì‹œ

3. **ë°±ì—”ë“œ ë©”ì‹œì§€ ì‘ë‹µ ê°œì„ **
   - `senderEmail` í•„ë“œë¥¼ DTOì— ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
   - `ChatResponseDTO.fromEntity()` ëŒ€ì‹  ì§ì ‘ DTO ìƒì„± (LazyInitializationException ë°©ì§€)
   - `unreadCount`ëŠ” DBì—ì„œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì„¤ì •

4. **WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ê°•í™”**
   - ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ ì¤‘ë³µ ì²´í¬ ìˆ˜í–‰
   - í˜„ì¬ ì„ íƒëœ ë°©ì¸ì§€ í™•ì¸ í›„ ë©”ì‹œì§€ ì¶”ê°€
   - ë‹¤ë¥¸ ë°©ì˜ ë©”ì‹œì§€ëŠ” í† ìŠ¤íŠ¸ ì•Œë¦¼ë§Œ í‘œì‹œ

5. **ë””ë²„ê¹… ë° ê²€ì¦**
   - ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ë¡œê·¸ í™•ì¸
   - ë©”ì‹œì§€ ì „ì†¡ í›„ ëª¨ë“  ì°¸ì—¬ì í™”ë©´ì—ì„œ ì¦‰ì‹œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
   - ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ë©”ì‹œì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ ê²€ì¦

---

### 3. ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ì˜ ì‹¤ì‹œê°„ ë°˜ì˜ ë¶€ì¬ ë° ë¶€ì •í™•í•œ unreadCount ê³„ì‚°

**ë¬¸ì œ ìƒí™©:**
- ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ì ‘ì†í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì½ì–´ë„ ë‹¤ë¥¸ ì°¸ì—¬ì í™”ë©´ì˜ `unreadCount`ê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ
- ìƒˆë¡œê³ ì¹¨ì„ í•´ì•¼ë§Œ `unreadCount`ê°€ ê°ì†Œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
- ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì•„ `unreadCount`ê°€ ë¶€ì •í™•í•˜ê²Œ ê³„ì‚°ë¨
- ì˜ˆ: 3ëª… ì°¸ì—¬ ë°©ì—ì„œ A, Bê°€ ì ‘ì† ì¤‘ì¼ ë•Œ Aê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ `unreadCount`ê°€ 2ë¡œ í‘œì‹œë¨ (ì‹¤ì œë¡œëŠ” 1ì´ì–´ì•¼ í•¨)

**ê¸°ìˆ ì  ì›ì¸:**
- ë°±ì—”ë“œì—ì„œ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ëŠ” ë˜ì§€ë§Œ WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì•Œë¦¼ì´ ì—†ìŒ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ `UNREAD_COUNT_UPDATE` íƒ€ì… ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì´ ì—†ìŒ
- `unreadCount` ê³„ì‚° ì‹œ í˜„ì¬ ì±„íŒ…ë°©ì— ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìë¥¼ ê³ ë ¤í•˜ì§€ ì•ŠìŒ
- ë°œì‹ ìì™€ ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìë„ `readYn=false`ë¡œ ì²˜ë¦¬ë˜ì–´ ë¶€ì •í™•í•œ ì¹´ìš´íŠ¸ ë°œìƒ

**ì˜í–¥:**
- ë©”ì‹œì§€ ì½ìŒ ìƒíƒœê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë˜ì§€ ì•Šì•„ í˜‘ì—… íš¨ìœ¨ì„± ì €í•˜
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì–´ë ¤ì›€
- ë¶€ì •í™•í•œ `unreadCount`ë¡œ ì¸í•œ ì‚¬ìš©ì í˜¼ë€

**í•´ê²° ë°©ë²•:**
1. **ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ê¸°ë°˜ unreadCount ê³„ì‚°**
   - WebSocket ì„¸ì…˜ì„ í†µí•´ í˜„ì¬ ì±„íŒ…ë°©ì— ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
   - ë°œì‹ ìì™€ ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìëŠ” ì¦‰ì‹œ `readYn=true`ë¡œ ì²˜ë¦¬
   - ë¯¸ì ‘ì† ì‚¬ìš©ìë§Œ `readYn=false`ë¡œ ì„¤ì •í•˜ì—¬ ì •í™•í•œ `unreadCount` ê³„ì‚°

2. **WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•**
   - ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì‹œ `UNREAD_COUNT_UPDATE` íƒ€ì… ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
   - ë°œì‹ ì ì •ë³´(`senderId`, `senderEmail`) í¬í•¨í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°œì‹ ì í™•ì¸ ê°€ëŠ¥
   - ëª¨ë“  ì°¸ì—¬ìì—ê²Œ ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡

3. **í”„ë¡ íŠ¸ì—”ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬**
   - `UNREAD_COUNT_UPDATE` ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
   - ë°œì‹ ìê°€ ìì‹ ì¸ ê²½ìš°ì—ë§Œ `unreadCount` ì—…ë°ì´íŠ¸ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì˜ ì½ìŒ ìˆ˜ ê°ì†Œ)
   - ì±„íŒ…ë°© ëª©ë¡ì˜ `unreadCount`ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸

4. **Service ë¡œì§ ê°œì„ **
   - `markMessagesAsRead` ë©”ì„œë“œì—ì„œ ì½ìŒ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
   - ê° ë©”ì‹œì§€ì˜ `unreadCount`ë¥¼ DBì—ì„œ ì¬ê³„ì‚°í•˜ì—¬ ì •í™•ë„ ë³´ì¥
   - íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì½ìŒ ì²˜ë¦¬ ë° `unreadCount` ê³„ì‚° ìˆ˜í–‰

5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ì—¬ëŸ¬ ì°¸ì—¬ìê°€ ìˆëŠ” ì±„íŒ…ë°©ì—ì„œ ë©”ì‹œì§€ ì½ìŒ í…ŒìŠ¤íŠ¸
   - ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ì— ë”°ë¥¸ `unreadCount` ì •í™•ë„ ê²€ì¦
   - ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ `unreadCount`ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì†Œí•˜ëŠ”ì§€ í™•ì¸

---

### 4. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ë¶€ì¡± ë° í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸í‘œì‹œ

**ë¬¸ì œ ìƒí™©:**
- ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì´ë¦„ë§Œ í‘œì‹œë˜ê³  ì§ê¸‰, ë¶€ì„œëª… ë“± ì¶”ê°€ ì •ë³´ê°€ ì—†ìŒ
- ì±„íŒ…ë°© ì°¸ì—¬ì ëª©ë¡ì—ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€, ì§ê¸‰, ë¶€ì„œëª…ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ
- í”„ë¡œí•„ ì´ë¯¸ì§€ URLì´ `undefined`ë¡œ ì „ë‹¬ë¨
- `senderEmail` í•„ë“œê°€ ëˆ„ë½ë˜ì–´ ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„ ë¶ˆê°€

**ê¸°ìˆ ì  ì›ì¸:**
- DTOì— `senderJobGrade`, `senderDeptName` í•„ë“œê°€ ì—†ìŒ
- Controllerì—ì„œ ë°œì‹ ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ DTOì— ì„¤ì •í•˜ëŠ” ë¡œì§ì´ ì—†ìŒ
- `ChatResponseDTO.fromEntity()`ì—ì„œ `chat.getSender()`ê°€ LAZY ë¡œë”©ë˜ì–´ `Department` ì ‘ê·¼ ì‹œ `LazyInitializationException` ë°œìƒ
- S3 URL ìƒì„± ë¡œì§ì´ ë©”ì‹œì§€ ì‘ë‹µì— í¬í•¨ë˜ì§€ ì•ŠìŒ
- `senderEmail` í•„ë“œê°€ DTOì— ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ë˜ì§€ ì•ŠìŒ

**ì˜í–¥:**
- ì¡°ì§ ë‚´ ê³„ì¸µ êµ¬ì¡° íŒŒì•…ì´ ì–´ë ¤ì›€
- ì‚¬ìš©ì ì‹ë³„ì´ ì–´ë ¤ì›Œ í˜‘ì—… íš¨ìœ¨ì„± ì €í•˜
- í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•Šì•„ ì‹œê°ì  ì‹ë³„ì„± ì €í•˜
- ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„ ë¶ˆê°€ë¡œ UI ì •ë ¬ ë¬¸ì œ ë°œìƒ

**í•´ê²° ë°©ë²•:**
1. **UserRepositoryì— Eager Loading ë©”ì„œë“œ ì¶”ê°€**
   - `findByEmailWithDepartment`, `findByIdWithDepartment` ë©”ì„œë“œ ì¶”ê°€
   - `LEFT JOIN FETCH u.department`ë¥¼ ì‚¬ìš©í•˜ì—¬ Departmentë¥¼ í•¨ê»˜ ë¡œë“œ
   - LazyInitializationException ë°©ì§€ë¥¼ ìœ„í•œ ì‚¬ì „ ì¡°íšŒ

2. **DTO í•„ë“œ ì¶”ê°€ ë° ì„¤ì •**
   - `ChatResponseDTO`ì— `senderJobGrade`, `senderDeptName`, `senderEmail` í•„ë“œ ì¶”ê°€
   - `@JsonInclude(JsonInclude.Include.ALWAYS)` ì¶”ê°€í•˜ì—¬ null ê°’ë„ JSONì— í¬í•¨
   - ë¹ˆ ë¬¸ìì—´(`""`)ë¡œ ì´ˆê¸°í™”í•˜ì—¬ í•„ë“œê°€ í•­ìƒ JSONì— í¬í•¨ë˜ë„ë¡ ì„¤ì •

3. **Controllerì—ì„œ ë°œì‹ ì ì •ë³´ ëª…ì‹œì  ì„¤ì •**
   - `@Transactional` ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€í•˜ì—¬ íŠ¸ëœì­ì…˜ ë³´ì¥
   - `findByEmailWithDepartment` ë©”ì„œë“œ ì‚¬ìš©í•˜ì—¬ Department í•¨ê»˜ ë¡œë“œ
   - íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ Department ì •ë³´ ì¦‰ì‹œ ì¶”ì¶œí•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥
   - `ChatResponseDTO.fromEntity()` ëŒ€ì‹  ì§ì ‘ DTO ìƒì„±í•˜ì—¬ LazyInitializationException ë°©ì§€

4. **S3 í”„ë¡œí•„ ì´ë¯¸ì§€ URL ìƒì„±**
   - `profileImageKey`ê°€ ìˆìœ¼ë©´ `s3Service.getFileUrl()` í˜¸ì¶œí•˜ì—¬ ì™„ì „í•œ URL ìƒì„±
   - ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ì„¤ì •í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì´ë‹ˆì…œ í‘œì‹œ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬
   - í”„ë¡œí•„ ì´ë¯¸ì§€ URLì„ DTOì— ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •

5. **í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ**
   - í”„ë¡œí•„ ì´ë¯¸ì§€, ì´ë¦„, ì§ê¸‰, ë¶€ì„œëª…ì„ í•¨ê»˜ í‘œì‹œí•˜ëŠ” UI êµ¬ì„±
   - í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì´ë‹ˆì…œ í‘œì‹œ
   - `senderEmail`ì„ ê¸°ë°˜ìœ¼ë¡œ ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„

6. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì •ë³´ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
   - í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ S3 URLë¡œ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
   - LazyInitializationExceptionì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ì§€ ê²€ì¦

---

### 5. JPA LazyInitializationException ë°œìƒ

**ë¬¸ì œ ìƒí™©:**
- `@MessageMapping` ë©”ì„œë“œì—ì„œ `Department` ì—”í‹°í‹°ì— ì ‘ê·¼í•  ë•Œ `LazyInitializationException` ë°œìƒ
- íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œëœ í›„ í”„ë¡ì‹œ ê°ì²´ì— ì ‘ê·¼í•˜ì—¬ ì—ëŸ¬ ë°œìƒ
- ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì„œë²„ ì—ëŸ¬ë¡œ ì¸í•´ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ

**ê¸°ìˆ ì  ì›ì¸:**
```java
// ë¬¸ì œê°€ ìˆë˜ ì½”ë“œ
@MessageMapping("/chat.sendMessage")
public void sendMessage(@Payload SendMessageRequestDTO req) {
    User authUser = userRepository.findByEmail(email).orElse(null);
    // ...
    ChatResponseDTO dto = ChatResponseDTO.fromEntity(saved);
    // fromEntity ë‚´ë¶€ì—ì„œ saved.getSender().getDepartment().getDeptName() í˜¸ì¶œ ì‹œ
    // íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ì–´ LazyInitializationException ë°œìƒ
}
```
- `User` ì—”í‹°í‹°ì˜ `Department` í•„ë“œê°€ `@ManyToOne(fetch = FetchType.LAZY)`ë¡œ ì„¤ì •ë¨
- `@MessageMapping` ë©”ì„œë“œì—ì„œ `@Transactional`ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- `ChatResponseDTO.fromEntity()`ì—ì„œ `chat.getSender()`ê°€ LAZY ë¡œë”©ë˜ì–´ íŠ¸ëœì­ì…˜ ì¢…ë£Œ í›„ ì ‘ê·¼ ë¶ˆê°€

**ì˜í–¥:**
- ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨
- ì„œë²„ ì—ëŸ¬ë¡œ ì¸í•œ ì‹œìŠ¤í…œ ë¶ˆì•ˆì •
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜

**í•´ê²° ë°©ë²•:**
1. **UserRepositoryì— Eager Loading ë©”ì„œë“œ ì¶”ê°€**
   - `findByEmailWithDepartment` ë©”ì„œë“œ ì¶”ê°€
   - `LEFT JOIN FETCH u.department`ë¥¼ ì‚¬ìš©í•˜ì—¬ Departmentë¥¼ í•¨ê»˜ ë¡œë“œ
   - íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ Department í”„ë¡ì‹œ ì´ˆê¸°í™” ë³´ì¥

2. **@Transactional ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€**
   - `@MessageMapping` ë©”ì„œë“œì— `@Transactional` ì¶”ê°€
   - íŠ¸ëœì­ì…˜ ë²”ìœ„ë¥¼ í™•ì¥í•˜ì—¬ Hibernate ì„¸ì…˜ì´ ì—´ë ¤ìˆëŠ” ìƒíƒœ ìœ ì§€
   - Department í”„ë¡ì‹œ ì ‘ê·¼ ì‹œ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì´ˆê¸°í™” ë³´ì¥

3. **Department ì •ë³´ ì¦‰ì‹œ ì¶”ì¶œ**
   - `findByEmailWithDepartment` í˜¸ì¶œ í›„ ì¦‰ì‹œ `getDepartment().getDeptName()` í˜¸ì¶œ
   - íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ Department ì •ë³´ë¥¼ ë³€ìˆ˜ì— ì €ì¥
   - ì´í›„ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ì–´ë„ ë³€ìˆ˜ì— ì €ì¥ëœ ê°’ ì‚¬ìš© ê°€ëŠ¥

4. **DTO ìƒì„± ë°©ì‹ ë³€ê²½**
   - `ChatResponseDTO.fromEntity()` ëŒ€ì‹  ì§ì ‘ DTO ìƒì„±
   - `chat.getSender()` í˜¸ì¶œì„ í”¼í•˜ê³  `authUser`ì—ì„œ ì§ì ‘ ì •ë³´ ì¶”ì¶œ
   - LazyInitializationException ë°œìƒ ê°€ëŠ¥ì„± ì™„ì „ ì œê±°

5. **ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”**
   - `try-catch` ë¸”ë¡ìœ¼ë¡œ LazyInitializationException ì²˜ë¦¬
   - ì˜ˆì™¸ ë°œìƒ ì‹œ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •í•˜ì—¬ ì‹œìŠ¤í…œ ì•ˆì •ì„± ë³´ì¥
   - ë¡œê·¸ë¥¼ í†µí•œ ì˜ˆì™¸ ì¶”ì  ë° ë””ë²„ê¹…

6. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ë©”ì‹œì§€ ì „ì†¡ ì‹œ LazyInitializationExceptionì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
   - Department ì •ë³´ê°€ ì •ìƒì ìœ¼ë¡œ DTOì— í¬í•¨ë˜ëŠ”ì§€ ê²€ì¦
   - ì—¬ëŸ¬ ì‚¬ìš©ìë¡œ ë™ì‹œ ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸

---

### 6. Spring ìˆœí™˜ ì°¸ì¡°(Circular Dependency) ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ `Circular dependency` ì—ëŸ¬ ë°œìƒ
- `chatMessageController` â†’ `chatRoomServiceImpl` â†’ `chatWebSocketHandler` â†’ `chatRoomService` ìˆœí™˜ ì°¸ì¡°

**ê¸°ìˆ ì  ì›ì¸:**
```java
// ChatRoomServiceImpl.java
@Service
public class ChatRoomServiceImpl implements ChatRoomService {
    private final ChatWebSocketHandler chatWebSocketHandler; // âš ï¸ ìˆœí™˜ ì°¸ì¡°
    // ...
}

// ChatWebSocketHandler.java
@Component
public class ChatWebSocketHandler {
    private final ChatRoomService chatRoomService; // âš ï¸ ìˆœí™˜ ì°¸ì¡°
    // ...
}
```
- `ChatRoomServiceImpl`ì´ `ChatWebSocketHandler`ë¥¼ ì£¼ì…ë°›ê³ 
- `ChatWebSocketHandler`ê°€ `ChatRoomService`(êµ¬í˜„ì²´: `ChatRoomServiceImpl`)ë¥¼ ì£¼ì…ë°›ì•„ ìˆœí™˜ ì°¸ì¡° ë°œìƒ

**ì˜í–¥:**
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨
- ì‹œìŠ¤í…œ ì „ì²´ ê¸°ëŠ¥ ì¤‘ë‹¨

**í•´ê²° ë°©ë²•:**
1. **ìˆœí™˜ ì°¸ì¡° êµ¬ì¡° ë¶„ì„**
   - ì˜ì¡´ì„± ê·¸ë˜í”„ ë¶„ì„: `ChatRoomServiceImpl` â†’ `ChatWebSocketHandler` â†’ `ChatRoomService`
   - ìˆœí™˜ ì°¸ì¡°ì˜ ê·¼ë³¸ ì›ì¸ íŒŒì•…
   - ì§ì ‘ì ì¸ Bean ì£¼ì…ì´ í•„ìš”í•œì§€ ì¬ê²€í† 

2. **Static ë©”ì„œë“œ íŒ¨í„´ ì ìš©**
   - `ChatWebSocketHandler`ì— `getConnectedUserIdsInRoomStatic` static ë©”ì„œë“œ ì¶”ê°€
   - `userSessions`ë¥¼ `public static final`ë¡œ ì„ ì–¸í•˜ì—¬ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½
   - Bean ì£¼ì… ì—†ì´ë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ êµ¬ì¡° ë³€ê²½

3. **ì˜ì¡´ì„± ì œê±°**
   - `ChatRoomServiceImpl`ì—ì„œ `ChatWebSocketHandler` Bean ì£¼ì… ì œê±°
   - Static ë©”ì„œë“œë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ìˆœí™˜ ì°¸ì¡° í•´ê²°
   - ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë˜ ì˜ì¡´ì„± êµ¬ì¡°ë§Œ ë³€ê²½

4. **ì„¸ì…˜ ê´€ë¦¬ êµ¬ì¡° ê°œì„ **
   - `userSessions`ë¥¼ `ConcurrentHashMap`ìœ¼ë¡œ ì„ ì–¸í•˜ì—¬ Thread-Safe ë³´ì¥
   - Static ë©”ì„œë“œì—ì„œ ì„¸ì…˜ ì¡°íšŒ ë¡œì§ êµ¬í˜„
   - ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›ì„ ìœ„í•œ `List<WebSocketSession>` êµ¬ì¡° ìœ ì§€

5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìˆœí™˜ ì°¸ì¡° ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
   - Static ë©”ì„œë“œ í˜¸ì¶œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦
   - ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ì¡°íšŒ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸

---

### 7. ë©”ì‹œì§€ ì¤‘ë³µ ë Œë”ë§ ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- ë™ì¼í•œ ë©”ì‹œì§€ê°€ ë°›ëŠ” ì‚¬ëŒì˜ ì±„íŒ…ë°©ì— ì¤‘ë³µí•´ì„œ ë Œë”ë§ë¨
- ê°™ì€ ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ ë²ˆ í™”ë©´ì— í‘œì‹œë˜ì–´ ì‚¬ìš©ì í˜¼ë€ ë°œìƒ

**ê¸°ìˆ ì  ì›ì¸:**
- `setMessages`ì˜ í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ë™ì‹œì— ì—¬ëŸ¬ ë²ˆ `handleNewMessage`ê°€ í˜¸ì¶œë˜ë©´ ê°ê°ì´ ì´ì „ ìƒíƒœ(`prev`)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬ë¥¼ í•˜ê²Œ ë¨
- WebSocket êµ¬ë…ì´ ì¤‘ë³µë  ìˆ˜ ìˆìŒ
- íŒŒì¼ ì—…ë¡œë“œ ë° ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œ ì¤‘ë³µ ì²´í¬ ë¡œì§ì´ ì—†ìŒ

**ì˜í–¥:**
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜
- ë©”ì‹œì§€ ëª©ë¡ì´ í˜¼ë€ìŠ¤ëŸ¬ì›Œì§
- ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ

**í•´ê²° ë°©ë²•:**
1. **useRefë¥¼ í™œìš©í•œ ì¦‰ì‹œ ì¤‘ë³µ ì²´í¬**
   - `processedMessageIdsRef`: ì²˜ë¦¬ ì™„ë£Œëœ ë©”ì‹œì§€ ID ì¶”ì 
   - `processingMessageIdsRef`: í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€ ID ì¶”ì 
   - `handleNewMessage` ì‹œì‘ ì‹œ ì¦‰ì‹œ ref ì²´í¬í•˜ì—¬ ë™ì‹œ í˜¸ì¶œ ë°©ì§€

2. **ì´ì¤‘ ì¤‘ë³µ ì²´í¬ ë¡œì§ êµ¬í˜„**
   - Ref ê¸°ë°˜ ì¦‰ì‹œ ì²´í¬: ë™ì‹œ í˜¸ì¶œ ì‹œì—ë„ ì¦‰ì‹œ ì°¨ë‹¨
   - State ê¸°ë°˜ ì²´í¬: `setMessages` ë‚´ë¶€ì—ì„œë„ ì¤‘ë³µ ì²´í¬
   - ë‘ ë‹¨ê³„ ëª¨ë‘ í†µê³¼í•´ì•¼ë§Œ ë©”ì‹œì§€ ì¶”ê°€

3. **íŒŒì¼ ì—…ë¡œë“œ ë° ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œ ì¤‘ë³µ ì²´í¬**
   - íŒŒì¼ ì—…ë¡œë“œ ì‘ë‹µ ë©”ì‹œì§€ ì¶”ê°€ ì „ ì¤‘ë³µ ì²´í¬
   - ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œ `Set`ì„ í™œìš©í•œ ì¤‘ë³µ í•„í„°ë§
   - ê¸°ì¡´ ë©”ì‹œì§€ IDì™€ ìƒˆ ë©”ì‹œì§€ ID ë¹„êµ

4. **ì±„íŒ…ë°© ë³€ê²½ ì‹œ ref ì´ˆê¸°í™”**
   - ì±„íŒ…ë°© ë³€ê²½ ì‹œ `processedMessageIdsRef`ì™€ `processingMessageIdsRef` ì´ˆê¸°í™”
   - ìƒˆ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ë„ë¡ ë³´ì¥
   - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

5. **ë©”ëª¨ë¦¬ ê´€ë¦¬**
   - ì²˜ë¦¬ ì™„ë£Œëœ ë©”ì‹œì§€ IDëŠ” ìµœëŒ€ 1000ê°œë§Œ ìœ ì§€
   - 1000ê°œ ì´ˆê³¼ ì‹œ ìµœê·¼ 500ê°œë§Œ ìœ ì§€í•˜ì—¬ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í™•ë³´
   - ë¶ˆí•„ìš”í•œ ë©”ì‹œì§€ ID ìë™ ì œê±°

6. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ë™ì¼í•œ ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ ë²ˆ ìˆ˜ì‹ ë˜ì–´ë„ ì¤‘ë³µ ë Œë”ë§ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
   - ë™ì‹œì— ì—¬ëŸ¬ ë©”ì‹œì§€ê°€ ë„ì°©í•´ë„ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ ê²€ì¦
   - ì±„íŒ…ë°© ë³€ê²½ í›„ ë©”ì‹œì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

---

### 8. ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì› ë¶€ì¬

**ë¬¸ì œ ìƒí™©:**
- í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë¸Œë¼ìš°ì €ë‚˜ íƒ­ì—ì„œ ì±„íŒ…ë°©ì— ì ‘ì†í•  ìˆ˜ ì—†ìŒ
- í•œ ì„¸ì…˜ë§Œ ìœ ì§€ë˜ì–´ ë‹¤ë¥¸ ì„¸ì…˜ì´ ëŠì–´ì§€ë©´ ì‚¬ìš©ìê°€ ë¯¸ì ‘ì†ìœ¼ë¡œ ì²˜ë¦¬ë¨

**ê¸°ìˆ ì  ì›ì¸:**
```java
// ê¸°ì¡´ ì½”ë“œ
public static final Map<Integer, WebSocketSession> userSessions = new ConcurrentHashMap<>();
// âš ï¸ í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ ì„¸ì…˜ë§Œ ì €ì¥ ê°€ëŠ¥
```
- `Map<Integer, WebSocketSession>` êµ¬ì¡°ë¡œ í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ ì„¸ì…˜ë§Œ ì €ì¥ ê°€ëŠ¥
- ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ì—ì„œ ì ‘ì†í•˜ë©´ ë§ˆì§€ë§‰ ì„¸ì…˜ë§Œ ë‚¨ê³  ì´ì „ ì„¸ì…˜ì´ ë®ì–´ì“°ê¸°ë¨

**ì˜í–¥:**
- ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ì‹œì— ì±„íŒ…í•  ìˆ˜ ì—†ìŒ
- ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ì§‘ê³„ê°€ ë¶€ì •í™•í•¨
- `unreadCount` ê³„ì‚°ì´ ë¶€ì •í™•í•´ì§

**í•´ê²° ë°©ë²•:**
1. **ì„¸ì…˜ ê´€ë¦¬ êµ¬ì¡° ë³€ê²½**
   - `Map<Integer, WebSocketSession>` â†’ `Map<Integer, List<WebSocketSession>>`ë¡œ ë³€ê²½
   - í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ì„¸ì…˜ì„ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ êµ¬ì¡° ê°œì„ 
   - `ConcurrentHashMap`ê³¼ `Collections.synchronizedList` ì‚¬ìš©í•˜ì—¬ Thread-Safe ë³´ì¥

2. **ì„¸ì…˜ ì¶”ê°€ ë¡œì§ ê°œì„ **
   - `afterConnectionEstablished`ì—ì„œ ê¸°ì¡´ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ì— ìƒˆ ì„¸ì…˜ ì¶”ê°€
   - `computeIfAbsent`ë¥¼ í™œìš©í•˜ì—¬ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„± í›„ ì¶”ê°€
   - ì„¸ì…˜ ì¶”ê°€ ì‹œ ë¡œê·¸ ì¶œë ¥í•˜ì—¬ ë””ë²„ê¹… ìš©ì´

3. **ì„¸ì…˜ ì œê±° ë¡œì§ ê°œì„ **
   - `afterConnectionClosed`ì—ì„œ íŠ¹ì • ì„¸ì…˜ë§Œ ì œê±° (`removeIf` í™œìš©)
   - ì„¸ì…˜ IDë¡œ ì •í™•íˆ ì‹ë³„í•˜ì—¬ ì œê±°
   - ëª¨ë“  ì„¸ì…˜ì´ ë‹«íˆë©´ userId ì œê±°í•˜ì—¬ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í™•ë³´

4. **ì ‘ì†ì ì¡°íšŒ ë¡œì§ ê°œì„ **
   - Static ë©”ì„œë“œì—ì„œ ëª¨ë“  ì‚¬ìš©ìì˜ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ
   - ì„¸ì…˜ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ ë°©ì— ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì ‘ì† ì¤‘ìœ¼ë¡œ íŒë‹¨
   - `session.isOpen()` ì²´í¬ë¡œ ìœ íš¨í•œ ì„¸ì…˜ë§Œ ê³ ë ¤

5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ì—ì„œ ë™ì‹œì— ì ‘ì† ê°€ëŠ¥í•œì§€ í™•ì¸
   - ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ê°€ ì •í™•í•˜ê²Œ ì§‘ê³„ë˜ëŠ”ì§€ ê²€ì¦
   - ì„¸ì…˜ ì œê±° ì‹œ ë‹¤ë¥¸ ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš° ì ‘ì† ìƒíƒœê°€ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸

---

### 9. STOMP ì—°ê²° ì•ˆì •ì„± ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„
- ì—°ê²°ì´ ëŠì–´ì¡Œì„ ë•Œ ì¬ì—°ê²° ë¡œì§ì´ ì—†ì–´ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨
- ë©”ì‹œì§€ ì „ì†¡ í›„ ì±„íŒ…ë°©ì— ë°”ì¸ë”©ë˜ì§€ ì•ŠìŒ

**ê¸°ìˆ ì  ì›ì¸:**
- `sendStompMessage` í•¨ìˆ˜ê°€ ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì§€ ì•ŠìŒ
- ì¬ì—°ê²° ë¡œì§ì´ ì—†ì–´ ì—°ê²°ì´ ëŠì–´ì§€ë©´ ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€
- Promise ê¸°ë°˜ì´ ì•„ë‹ˆì–´ì„œ ì—°ê²° ëŒ€ê¸° ë¡œì§ì´ ì—†ìŒ

**ì˜í–¥:**
- ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜
- ì‹¤ì‹œê°„ ì±„íŒ… ê¸°ëŠ¥ ë¶ˆì•ˆì •

**í•´ê²° ë°©ë²•:**
1. **Promise ê¸°ë°˜ sendStompMessage êµ¬í˜„**
   - `sendStompMessage` í•¨ìˆ˜ë¥¼ `async` í•¨ìˆ˜ë¡œ ë³€ê²½
   - ì—°ê²° ìƒíƒœ í™•ì¸ í›„ ë©”ì‹œì§€ ì „ì†¡
   - Promiseë¥¼ ë°˜í™˜í•˜ì—¬ í˜¸ì¶œë¶€ì—ì„œ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬ ê°€ëŠ¥

2. **ì—°ê²° ìƒíƒœ í™•ì¸ ë° ìë™ ì¬ì—°ê²°**
   - `ensureConnected` í•¨ìˆ˜ êµ¬í˜„: ì—°ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¬ì—°ê²° ì‹œë„
   - `waitForConnection` í•¨ìˆ˜ êµ¬í˜„: ì—°ê²°ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
   - ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì„¤ì •(ê¸°ë³¸ 5ì´ˆ)í•˜ì—¬ ë¬´í•œ ëŒ€ê¸° ë°©ì§€

3. **ì¬ì—°ê²° ì½œë°± ì§€ì›**
   - `reconnectCallbacks` íŒŒë¼ë¯¸í„° ì¶”ê°€: `onMessage`, `onConnect`, `onError` ì½œë°±
   - ì¬ì—°ê²° ì‹œ ê¸°ì¡´ êµ¬ë… ì •ë³´ ìœ ì§€
   - ì—°ê²° ì„±ê³µ/ì‹¤íŒ¨ ì‹œ ì½œë°± í˜¸ì¶œ

4. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**
   - ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
   - ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥í•˜ë„ë¡ êµ¬ì¡°í™”
   - ë¡œê·¸ë¥¼ í†µí•œ ì—°ê²° ìƒíƒœ ì¶”ì 

5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ì—°ê²°ì´ ëŠì–´ì§„ ìƒíƒœì—ì„œ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„ ì‹œ ìë™ ì¬ì—°ê²°ë˜ëŠ”ì§€ í™•ì¸
   - ì¬ì—°ê²° í›„ ë©”ì‹œì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì „ì†¡ë˜ëŠ”ì§€ ê²€ì¦
   - ì—¬ëŸ¬ ë²ˆ ì¬ì—°ê²°í•´ë„ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸

---

## ğŸŸ¢ TO-BE (ê°œì„  í›„)

### 1. ë³µí•©í‚¤ë¥¼ í™œìš©í•œ ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- `chat_message_read_status` í…Œì´ë¸”ì˜ PKë¥¼ `(chat_message_id, user_id)` ë³µí•©í‚¤ë¡œ ë³€ê²½
- JPA `@IdClass`ë¥¼ í™œìš©í•˜ì—¬ ë³µí•©í‚¤ ì—”í‹°í‹° êµ¬ì¡° êµ¬í˜„
- ëª¨ë“  COUNT ì¿¼ë¦¬ë¥¼ `COUNT(1)`ë¡œ ë³€ê²½í•˜ì—¬ ë³µí•©í‚¤ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •

**êµ¬í˜„ ë‚´ìš©:**

#### 1-1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½
```sql
-- ê¸°ì¡´ PK ì œê±° ë° ë³µí•©í‚¤ ì¶”ê°€
ALTER TABLE chat_message_read_status DROP PRIMARY KEY;
ALTER TABLE chat_message_read_status DROP FOREIGN KEY FKp9p7w5sj5aopv7smji7xsxpj8;
ALTER TABLE chat_message_read_status DROP FOREIGN KEY FKela0ovgje0efmur1lby6xv85q;

-- NOT NULL ì„¤ì •
ALTER TABLE chat_message_read_status MODIFY chat_message_id INT NOT NULL;
ALTER TABLE chat_message_read_status MODIFY user_id INT NOT NULL;

-- ë³µí•©í‚¤ ì¶”ê°€
ALTER TABLE chat_message_read_status 
ADD PRIMARY KEY (chat_message_id, user_id);

-- Foreign Key ì œì•½ ì¬ì„¤ì •
ALTER TABLE chat_message_read_status 
ADD CONSTRAINT FK_chat_message_read_status_chat 
FOREIGN KEY (chat_message_id) REFERENCES chat_message(id),
ADD CONSTRAINT FK_chat_message_read_status_user 
FOREIGN KEY (user_id) REFERENCES users(user_id);
```

#### 1-2. ë³µí•©í‚¤ í´ë˜ìŠ¤ ìƒì„±
```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode
public class ChatMessageReadStatusId implements Serializable {
    private Integer chat;  // Chat ì—”í‹°í‹°ì˜ id
    private Integer user;  // User ì—”í‹°í‹°ì˜ id
}
```

#### 1-3. ì—”í‹°í‹° ìˆ˜ì •
```java
@Entity
@Table(name = "chat_message_read_status")
@IdClass(ChatMessageReadStatusId.class)
public class ChatMessageReadStatus {
    @Id
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "chat_message_id", nullable = false)
    private Chat chat;
    
    @Id
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
    
    private Boolean readYn = false;
    private LocalDateTime readAt;
    
    // ì½ìŒ ìƒíƒœ ì´ˆê¸°í™” ë©”ì„œë“œ ì¶”ê°€
    public void resetReadStatus() {
        this.readYn = false;
        this.readAt = null;
    }
}
```

#### 1-4. Repository ìˆ˜ì •
```java
// ë³µí•©í‚¤ íƒ€ì…ìœ¼ë¡œ ë³€ê²½
public interface ChatMessageReadStatusRepository 
    extends JpaRepository<ChatMessageReadStatus, ChatMessageReadStatusId> {
    
    // â­ COUNT ì¿¼ë¦¬ ìˆ˜ì • (ë³µí•©í‚¤ ì‚¬ìš©ìœ¼ë¡œ COUNT(1) ì‚¬ìš©)
    @Query("SELECT COUNT(1) FROM ChatMessageReadStatus r " +
           "WHERE r.chat.id = :chatId AND r.readYn = false " +
           "AND r.user.id != (SELECT c.sender.id FROM Chat c WHERE c.id = :chatId)")
    int countUnreadByChatId(@Param("chatId") Integer chatId);
    
    // ë³µí•©í‚¤ ê¸°ë°˜ ì¡°íšŒ ë©”ì„œë“œ
    Optional<ChatMessageReadStatus> findByChatIdAndUserId(Integer chatId, Integer userId);
}
```

#### 1-5. Service ë¡œì§ ê°œì„ 
```java
@Transactional
public Chat sendChatMessage(Integer roomId, Integer senderId, Object content) {
    // ... ë©”ì‹œì§€ ì €ì¥ ë¡œì§ ...
    
    List<ChatRoomUser> participants = chatRoomUserRepository.findByChatRoomId(roomId);
    List<Integer> connectedUserIds = getConnectedUserIdsInRoom(roomId);
    
    // ê° ì°¸ì—¬ìë³„ë¡œ ì½ìŒ ìƒíƒœ ìƒì„± (ë³µí•©í‚¤ë¡œ ì¤‘ë³µ ë°©ì§€)
    for (ChatRoomUser participant : participants) {
        Optional<ChatMessageReadStatus> existingStatus = 
            chatMessageReadStatusRepository.findByChatIdAndUserId(
                chat.getId(), participant.getUser().getId());
        
        ChatMessageReadStatus readStatus;
        if (existingStatus.isPresent()) {
            // â­ ê¸°ì¡´ row ì¬ì‚¬ìš© (ë³µí•©í‚¤ë¡œ ìë™ update)
            readStatus = existingStatus.get();
            readStatus.resetReadStatus();
        } else {
            readStatus = ChatMessageReadStatus.create(chat, participant.getUser());
        }
        
        // ë°œì‹ ì ë˜ëŠ” ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìëŠ” ì¦‰ì‹œ ì½ìŒ ì²˜ë¦¬
        if (participant.getUser().getId().equals(senderId) || 
            connectedUserIds.contains(participant.getUser().getId())) {
            readStatus.markRead();
        }
        
        chatMessageReadStatusRepository.save(readStatus);
    }
    
    chatMessageReadStatusRepository.flush(); // ì¦‰ì‹œ DB ë°˜ì˜
    
    // â­ unreadCountëŠ” DBì—ì„œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì„¤ì •
    int dbUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(chat.getId());
    chat.setUnreadCount(dbUnreadCount);
    
    return chat;
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ë³„ë¡œ ê° ì°¸ì—¬ìì˜ ì½ìŒ ìƒíƒœê°€ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë¨
- âœ… `unreadCount`ê°€ ì •í™•í•˜ê²Œ ê³„ì‚°ë˜ì–´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë¨
- âœ… ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ë° ì¤‘ë³µ ì €ì¥ ë°©ì§€
- âœ… ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜ê°€ ì •í™•í•˜ê²Œ í‘œì‹œë¨
- âœ… `Unknown column` ì—ëŸ¬ í•´ê²°

---

### 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  ê°œì„ 

**í•´ê²° ë°©ì•ˆ:**
- í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ëŠ” `roomList` ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì¶”ê°€ë˜ë„ë¡ ë¡œì§ ìˆ˜ì •
- Optimistic UI Update ì œê±°í•˜ê³  ì„œë²„ ì‘ë‹µ ë©”ì‹œì§€ë§Œ í‘œì‹œ
- WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë°œì‹ ì ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ ë©”ì‹œì§€/ìƒëŒ€ë°© ë©”ì‹œì§€ êµ¬ë¶„

**êµ¬í˜„ ë‚´ìš©:**

#### 2-1. í”„ë¡ íŠ¸ì—”ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  ë¡œì§ ê°œì„ 
```javascript
const handleNewMessage = (msg) => {
  // ë°œì‹ ì ì´ë©”ì¼ë¡œ ë‚´ ë©”ì‹œì§€ íŒë³„
  const isMyMessage = 
    msg.senderEmail && 
    userProfile?.email && 
    msg.senderEmail.trim().toLowerCase() === userProfile.email.trim().toLowerCase();
  
  // ë‚´ ë©”ì‹œì§€ì¸ ê²½ìš°
  if (isMyMessage) {
    if (Number(msg.roomId) === Number(selectedRoomId)) {
      // â­ ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€
      setMessages((prev) => {
        const exists = prev.some(m => Number(m?.id) === Number(msg?.id));
        if (exists) return prev;
        return [...prev, msg];
      });
    }
    return;
  }
  
  // ìƒëŒ€ë°© ë©”ì‹œì§€ì¸ ê²½ìš°
  const roomIdNum = Number(msg.roomId);
  
  // â­ í˜„ì¬ ì„ íƒëœ ë°©ì˜ ë©”ì‹œì§€ëŠ” foundRoomì´ ì—†ì–´ë„ ì¶”ê°€
  if (roomIdNum === Number(selectedRoomId)) {
    setMessages((prev) => {
      // â­ ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€
      const exists = prev.some(m => Number(m?.id) === Number(msg?.id));
      if (exists) return prev;
      return [...prev, msg];
    });
  } else {
    // ë‹¤ë¥¸ ë°©ì˜ ë©”ì‹œì§€ëŠ” í† ìŠ¤íŠ¸ ì•Œë¦¼ë§Œ í‘œì‹œ
    const foundRoom = roomList.find(r => r && Number(r.roomId) === roomIdNum);
    if (foundRoom) {
      setToastRooms((prev) => [...prev, toastInfo]);
    }
  }
};
```

#### 2-2. Optimistic UI Update ì œê±°
```javascript
// ì´ì „ ì½”ë“œ (ì œê±°ë¨)
const tempMessage = {
  id: `temp-${Date.now()}`,
  content: message,
  // ...
};
setMessages(prev => [...prev, tempMessage]); // âš ï¸ ì œê±°

// ê°œì„ ëœ ì½”ë“œ
const handleSend = (message) => {
  // â­ ì„œë²„ì—ì„œ WebSocketìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì•¼ë§Œ UIì— í‘œì‹œë¨
  sendStompMessage({ roomId: selectedRoomId, content: message });
  inputRef.current.value = "";
};
```

#### 2-3. ë°±ì—”ë“œ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ë°œì‹ ì ì •ë³´ í¬í•¨
```java
@MessageMapping("/chat.sendMessage")
@Transactional
public void sendMessage(@Payload SendMessageRequestDTO req, 
                       SimpMessageHeaderAccessor headerAccessor) {
    String email = (String) headerAccessor.getSessionAttributes().get("wsUserEmail");
    User authUser = userRepository.findByEmailWithDepartment(email).orElse(null);
    
    Chat saved = chatRoomService.sendChatMessage(req.getRoomId(), authUser.getId(), req.getContent());
    
    // â­ fromEntity() ëŒ€ì‹  ì§ì ‘ DTO ìƒì„± (LazyInitializationException ë°©ì§€)
    ChatResponseDTO responseDto = new ChatResponseDTO();
    responseDto.setId(saved.getId());
    responseDto.setMessageContent(saved.getMessageContent());
    responseDto.setSenderId(authUser.getId());
    responseDto.setSenderName(authUser.getName());
    responseDto.setSenderEmail(authUser.getEmail()); // â­ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
    
    // â­ unreadCountëŠ” DBì—ì„œ ì§ì ‘ ì¡°íšŒ
    int confirmedUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(saved.getId());
    responseDto.setUnreadCount(confirmedUnreadCount);
    
    messagingTemplate.convertAndSend("/topic/chat.room." + req.getRoomId(), responseDto);
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ ì „ì†¡ ì¦‰ì‹œ ëª¨ë“  ì°¸ì—¬ì í™”ë©´ì— ì‹¤ì‹œê°„ í‘œì‹œ
- âœ… ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ë©”ì‹œì§€ í™•ì¸ ê°€ëŠ¥
- âœ… ì‹¤ì‹œê°„ ì±„íŒ…ì˜ í•µì‹¬ ê¸°ëŠ¥ ì •ìƒ ì‘ë™
- âœ… ì„ì‹œ ë©”ì‹œì§€ ì œê±°ë¡œ UI ì¼ê´€ì„± í–¥ìƒ

---

### 3. ì‹¤ì‹œê°„ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶• ë° ì •í™•í•œ unreadCount ê³„ì‚°

**í•´ê²° ë°©ì•ˆ:**
- ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì‹œ WebSocketì„ í†µí•´ `UNREAD_COUNT_UPDATE` ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
- ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ë¥¼ ê³ ë ¤í•œ ë™ì  `unreadCount` ê³„ì‚°

**êµ¬í˜„ ë‚´ìš©:**

#### 3-1. ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ê¸°ë°˜ unreadCount ê³„ì‚°
```java
@Transactional
public Chat sendChatMessage(Integer roomId, Integer senderId, Object content) {
    // ... ë©”ì‹œì§€ ì €ì¥ ë¡œì§ ...
    
    // â­ í˜„ì¬ ì±„íŒ…ë°©ì— ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ì‹¤ì‹œê°„ WebSocket ì„¸ì…˜ ê¸°ë°˜)
    List<Integer> connectedUserIds = getConnectedUserIdsInRoom(roomId);
    
    for (ChatRoomUser participant : participants) {
        // â­ ë°œì‹ ìì´ê±°ë‚˜ ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìë¼ë©´ ë°”ë¡œ ì½ìŒ ì²˜ë¦¬
        if (participant.getUser().getId().equals(senderId) || 
            connectedUserIds.contains(participant.getUser().getId())) {
            readStatus.markRead(); // readYn = true
        } else {
            // â­ ë°œì‹ ìê°€ ì•„ë‹ˆê³  ì ‘ì† ì¤‘ì´ ì•„ë‹Œ ê²½ìš° readYn = false
            readStatus.setReadYn(false);
        }
    }
    
    chatMessageReadStatusRepository.flush();
    
    // â­ unreadCountëŠ” DBì—ì„œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì„¤ì •
    int dbUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(chat.getId());
    chat.setUnreadCount(dbUnreadCount);
    
    return chat;
}
```

#### 3-2. ë°±ì—”ë“œ ì½ìŒ ì²˜ë¦¬ ë° WebSocket ì•Œë¦¼
```java
@PatchMapping("/rooms/{roomId}/messages/read")
public ResponseEntity<?> markRoomMessagesAsRead(
        @PathVariable Integer roomId, 
        @AuthenticationPrincipal CustomUserDetails customUserDetails) {
    
    User user = userRepository.findByEmail(customUserDetails.getEmail()).orElseThrow();
    
    // ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ë° ì½ìŒ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    List<Integer> readChatIds = chatRoomService.markMessagesAsRead(roomId, user.getId());
    
    // ê° ë©”ì‹œì§€ì˜ unreadCountë¥¼ -1 ê°ì†Œì‹œí‚¤ê³  WebSocketìœ¼ë¡œ ì•Œë¦¼
    for (Integer chatId : readChatIds) {
        Chat chat = chatRepository.findById(chatId).orElse(null);
        if (chat != null) {
            // â­ unreadCount ì¬ê³„ì‚° (DBì—ì„œ ì§ì ‘ ì¡°íšŒ)
            int realUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(chatId);
            
            Map<String, Object> updateMessage = new HashMap<>();
            updateMessage.put("type", "UNREAD_COUNT_UPDATE");
            updateMessage.put("chatId", chatId);
            updateMessage.put("unreadCount", realUnreadCount);
            updateMessage.put("roomId", roomId);
            updateMessage.put("senderId", chat.getSender().getId());
            updateMessage.put("senderEmail", chat.getSender().getEmail());
            
            // ëª¨ë“  ì°¸ì—¬ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
            messagingTemplate.convertAndSend("/topic/chat.room." + roomId, updateMessage);
        }
    }
    
    return ResponseEntity.ok().build();
}
```

#### 3-3. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
```javascript
const handleNewMessage = (msg) => {
  // UNREAD_COUNT_UPDATE ë©”ì‹œì§€ ì²˜ë¦¬
  if (msg.type === "UNREAD_COUNT_UPDATE") {
    const { chatId, unreadCount, roomId, senderId, senderEmail } = msg;
    
    // â­ ë°œì‹ ìê°€ ìì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì˜ unreadCount ê°ì†Œ)
    const isMyMessage = senderEmail && userProfile?.email && 
      senderEmail.trim().toLowerCase() === userProfile.email.trim().toLowerCase();
    
    if (isMyMessage && Number(roomId) === Number(selectedRoomId)) {
      setMessages((prev) =>
        prev.map((m) =>
          Number(m.id) === Number(chatId)
            ? { ...m, unreadCount: unreadCount != null ? unreadCount : 0 }
            : m
        )
      );
    }
    
    return;
  }
  
  // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬...
};
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ ì½ìŒ ì¦‰ì‹œ ëª¨ë“  ì°¸ì—¬ì í™”ë©´ì—ì„œ `unreadCount` ì‹¤ì‹œê°„ ê°ì†Œ
- âœ… ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ì½ìŒ ìƒíƒœ ë°˜ì˜
- âœ… ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ë¥¼ ê³ ë ¤í•œ ì •í™•í•œ `unreadCount` ê³„ì‚°
- âœ… í˜‘ì—… íš¨ìœ¨ì„± í–¥ìƒ ë° ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

### 4. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì‹œìŠ¤í…œ êµ¬ì¶• ë° LazyInitializationException í•´ê²°

**í•´ê²° ë°©ì•ˆ:**
- DTOì— ë°œì‹ ì ì§ê¸‰, ë¶€ì„œëª… í•„ë“œ ì¶”ê°€
- `UserRepository`ì— `findByEmailWithDepartment`, `findByIdWithDepartment` ë©”ì„œë“œ ì¶”ê°€í•˜ì—¬ Eager Loading êµ¬í˜„
- Controllerì—ì„œ ë°œì‹ ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ DTOì— ì„¤ì •
- `ChatResponseDTO.fromEntity()` ëŒ€ì‹  ì§ì ‘ DTO ìƒì„±í•˜ì—¬ LazyInitializationException ë°©ì§€

**êµ¬í˜„ ë‚´ìš©:**

#### 4-1. UserRepositoryì— Eager Loading ë©”ì„œë“œ ì¶”ê°€
```java
public interface UserRepository extends JpaRepository<User, Integer> {
    // â­ Departmentë¥¼ í•¨ê»˜ ë¡œë“œí•˜ì—¬ LazyInitializationException ë°©ì§€
    @Query("""
        SELECT u FROM User u
        LEFT JOIN FETCH u.department
        WHERE u.email = :email
        """)
    Optional<User> findByEmailWithDepartment(@Param("email") String email);
    
    @Query("""
        SELECT u FROM User u
        LEFT JOIN FETCH u.department
        WHERE u.id = :id
        """)
    Optional<User> findByIdWithDepartment(@Param("id") Integer id);
}
```

#### 4-2. DTO í•„ë“œ ì¶”ê°€
```java
@Getter
@Setter
@Builder
public class ChatResponseDTO {
    private Integer id;
    private String senderName;
    private String senderEmail;
    private String senderProfileImageUrl;
    private JobGrade senderJobGrade;  // â­ ì§ê¸‰ í•„ë“œ ì¶”ê°€
    private String senderDeptName;    // â­ ë¶€ì„œëª… í•„ë“œ ì¶”ê°€
    private Integer unreadCount;
    // ...
}
```

#### 4-3. Controllerì—ì„œ ë°œì‹ ì ì •ë³´ ì„¤ì • (LazyInitializationException ë°©ì§€)
```java
@MessageMapping("/chat.sendMessage")
@Transactional
public void sendMessage(@Payload SendMessageRequestDTO req, 
                       SimpMessageHeaderAccessor headerAccessor) {
    String email = (String) headerAccessor.getSessionAttributes().get("wsUserEmail");
    
    // â­ Departmentë¥¼ í•¨ê»˜ ë¡œë“œí•˜ëŠ” ë©”ì„œë“œ ì‚¬ìš©
    User authUser = userRepository.findByEmailWithDepartment(email).orElse(null);
    
    // â­ Department ì •ë³´ë¥¼ ì¦‰ì‹œ ì¶”ì¶œí•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥ (íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ)
    String deptName = null;
    String profileImageKey = null;
    try {
        if (authUser.getDepartment() != null) {
            deptName = authUser.getDepartment().getDeptName(); // í”„ë¡ì‹œ ì´ˆê¸°í™”
        }
        profileImageKey = authUser.getProfileImageKey();
    } catch (LazyInitializationException e) {
        log.error("Department ì ‘ê·¼ ì‹¤íŒ¨: {}", e.getMessage());
    }
    
    Chat saved = chatRoomService.sendChatMessage(req.getRoomId(), authUser.getId(), req.getContent());
    
    // â­ fromEntity() ëŒ€ì‹  ì§ì ‘ DTO ìƒì„± (LazyInitializationException ë°©ì§€)
    ChatResponseDTO responseDto = new ChatResponseDTO();
    responseDto.setId(saved.getId());
    responseDto.setMessageContent(saved.getMessageContent());
    responseDto.setSenderId(authUser.getId());
    responseDto.setSenderName(authUser.getName());
    responseDto.setSenderEmail(authUser.getEmail());
    
    // â­ ë¯¸ë¦¬ ì¶”ì¶œí•œ ê°’ ì‚¬ìš©
    if (profileImageKey != null && !profileImageKey.isBlank()) {
        responseDto.setSenderProfileImageUrl(s3Service.getFileUrl(profileImageKey));
    } else {
        responseDto.setSenderProfileImageUrl("");
    }
    
    responseDto.setSenderJobGrade(authUser.getJobGrade());
    responseDto.setSenderDeptName(deptName != null ? deptName : "");
    
    messagingTemplate.convertAndSend("/topic/chat.room." + req.getRoomId(), responseDto);
}
```

#### 4-4. í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
```javascript
// ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì •ë³´ í‘œì‹œ
<Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 0.5 }}>
  <Avatar src={msg.senderProfileImageUrl} sx={{ width: 36, height: 36 }}>
    {!msg.senderProfileImageUrl && (msg.senderName?.[0]?.toUpperCase() || "?")}
  </Avatar>
  <Box>
    <Typography sx={{ fontSize: 13, fontWeight: 700 }}>
      {msg.senderName}
    </Typography>
    <Box sx={{ display: "flex", gap: 0.5, alignItems: "center" }}>
      {msg.senderJobGrade && (
        <Typography sx={{ fontSize: 12, color: "text.secondary" }}>
          {getJobGradeLabel(msg.senderJobGrade)}
        </Typography>
      )}
      {msg.senderDeptName && (
        <Typography sx={{ fontSize: 12, color: "primary.main" }}>
          {msg.senderDeptName}
        </Typography>
      )}
    </Box>
  </Box>
</Box>
```

**ê°œì„  íš¨ê³¼:**
- âœ… ì±„íŒ… ë©”ì‹œì§€ì— ë°œì‹ ì ì´ë¦„, ì§ê¸‰, ë¶€ì„œëª…ì´ í•¨ê»˜ í‘œì‹œë˜ì–´ ì‚¬ìš©ì ì‹ë³„ ìš©ì´
- âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œë¡œ ì‹œê°ì  ì‹ë³„ì„± í–¥ìƒ
- âœ… ì¡°ì§ ë‚´ ê³„ì¸µ êµ¬ì¡° íŒŒì•… ìš©ì´
- âœ… LazyInitializationException ì™„ì „ í•´ê²°

---

### 5. Spring ìˆœí™˜ ì°¸ì¡° í•´ê²°

**í•´ê²° ë°©ì•ˆ:**
- `ChatWebSocketHandler`ì— static ë©”ì„œë“œ ì¶”ê°€í•˜ì—¬ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„
- `ChatRoomServiceImpl`ì—ì„œ `ChatWebSocketHandler` ì§ì ‘ ì£¼ì… ì œê±°

**êµ¬í˜„ ë‚´ìš©:**

#### 5-1. ChatWebSocketHandlerì— Static ë©”ì„œë“œ ì¶”ê°€
```java
@Component
public class ChatWebSocketHandler {
    // â­ static í•„ë“œë¡œ ì„¸ì…˜ ê´€ë¦¬
    public static final Map<Integer, List<WebSocketSession>> userSessions = new ConcurrentHashMap<>();
    
    // â­ static ë©”ì„œë“œë¡œ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„
    public static List<Integer> getConnectedUserIdsInRoomStatic(Integer roomId) {
        List<Integer> connectedUserIds = new ArrayList<>();
        
        for (Map.Entry<Integer, List<WebSocketSession>> entry : userSessions.entrySet()) {
            Integer userId = entry.getKey();
            List<WebSocketSession> sessions = entry.getValue();
            
            // í•´ë‹¹ ì‚¬ìš©ìì˜ ì„¸ì…˜ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ ë°©ì— ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì ‘ì† ì¤‘ìœ¼ë¡œ íŒë‹¨
            boolean isConnectedToRoom = sessions.stream()
                .anyMatch(session -> {
                    Map<String, Object> attributes = session.getAttributes();
                    Integer sessionRoomId = (Integer) attributes.get("roomId");
                    return session.isOpen() && sessionRoomId != null && sessionRoomId.equals(roomId);
                });
            
            if (isConnectedToRoom) {
                connectedUserIds.add(userId);
            }
        }
        
        return connectedUserIds;
    }
}
```

#### 5-2. ChatRoomServiceImplì—ì„œ Static ë©”ì„œë“œ í˜¸ì¶œ
```java
@Service
public class ChatRoomServiceImpl implements ChatRoomService {
    // â­ ChatWebSocketHandler ì£¼ì… ì œê±°
    
    @Override
    public List<Integer> getConnectedUserIdsInRoom(Integer roomId) {
        // â­ ìˆœí™˜ ì°¸ì¡° ë°©ì§€: ChatWebSocketHandlerì˜ static ë©”ì„œë“œë¥¼ ì§ì ‘ í˜¸ì¶œ
        List<Integer> connectedUserIds = 
            ChatWebSocketHandler.getConnectedUserIdsInRoomStatic(roomId);
        
        log.info("[ChatRoomService.getConnectedUserIdsInRoom] roomId: {}, ì ‘ì†ììˆ˜: {}", 
                roomId, connectedUserIds.size());
        
        return connectedUserIds;
    }
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… ìˆœí™˜ ì°¸ì¡° ì™„ì „ í•´ê²°
- âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹œì‘
- âœ… ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ

---

### 6. ë©”ì‹œì§€ ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- `useRef`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬ëœ ë©”ì‹œì§€ IDë¥¼ ì¶”ì í•˜ì—¬ ì¦‰ì‹œ ì¤‘ë³µ ì²´í¬
- íŒŒì¼ ì—…ë¡œë“œ ë° ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œì—ë„ ì¤‘ë³µ ì²´í¬ ë¡œì§ ì¶”ê°€
- WebSocket êµ¬ë… ì¤‘ë³µ ë°©ì§€

**êµ¬í˜„ ë‚´ìš©:**

#### 6-1. useRefë¥¼ ì‚¬ìš©í•œ ì¦‰ì‹œ ì¤‘ë³µ ì²´í¬
```javascript
// â­ ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€: ìµœê·¼ ì²˜ë¦¬í•œ ë©”ì‹œì§€ ID ì¶”ì  (ë™ì‹œ í˜¸ì¶œ ë°©ì§€)
const processedMessageIdsRef = useRef(new Set());
const processingMessageIdsRef = useRef(new Set()); // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë©”ì‹œì§€ ID

const handleNewMessage = (msg) => {
  const msgId = msg?.id;
  if (msgId == null) return;
  
  const numMsgId = Number(msgId);
  
  // â­ ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì²˜ë¦¬ëœ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (ì¦‰ì‹œ ì²´í¬)
  if (processingMessageIdsRef.current.has(numMsgId) || 
      processedMessageIdsRef.current.has(numMsgId)) {
    console.log("ğŸ“¨ [ChatLayout] ì¤‘ë³µ ë©”ì‹œì§€ ë¬´ì‹œ (ref ì²´í¬):", {
      messageId: msgId,
      ì²˜ë¦¬ì¤‘: processingMessageIdsRef.current.has(numMsgId),
      ì²˜ë¦¬ì™„ë£Œ: processedMessageIdsRef.current.has(numMsgId)
    });
    return;
  }
  
  // â­ ì²˜ë¦¬ ì¤‘ í‘œì‹œ
  processingMessageIdsRef.current.add(numMsgId);
  
  setMessages((prev) => {
    // â­ ì´ì¤‘ ì²´í¬: refì™€ state ëª¨ë‘ í™•ì¸
    const existsInState = prev.some(m => {
      const mId = m?.id;
      if (mId == null) return false;
      return Number(mId) === numMsgId;
    });
    
    if (existsInState) {
      processingMessageIdsRef.current.delete(numMsgId);
      return prev;
    }
    
    // â­ ì²˜ë¦¬ ì™„ë£Œ í‘œì‹œ
    processingMessageIdsRef.current.delete(numMsgId);
    processedMessageIdsRef.current.add(numMsgId);
    
    // â­ ë©”ëª¨ë¦¬ ê´€ë¦¬: ìµœëŒ€ 1000ê°œë§Œ ìœ ì§€
    if (processedMessageIdsRef.current.size > 1000) {
      const idsArray = Array.from(processedMessageIdsRef.current);
      processedMessageIdsRef.current = new Set(idsArray.slice(-500));
    }
    
    return [...prev, newMessage];
  });
};
```

#### 6-2. íŒŒì¼ ì—…ë¡œë“œ ë° ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œ ì¤‘ë³µ ì²´í¬
```javascript
// íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì¤‘ë³µ ì²´í¬
setMessages((prev) => {
  const exists = prev.some(m => Number(m?.id) === Number(chatMessage?.id));
  if (exists) return prev;
  return [...prev, chatMessage];
});

// ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì‹œ ì¤‘ë³µ ì²´í¬
setMessages(prev => {
  const existingIds = new Set(prev.map(m => Number(m?.id)).filter(id => id != null));
  const filteredNewMessages = newMessages.filter(msg => 
    !existingIds.has(Number(msg?.id))
  );
  return [...filteredNewMessages, ...prev];
});
```

#### 6-3. ì±„íŒ…ë°© ë³€ê²½ ì‹œ ref ì´ˆê¸°í™”
```javascript
useEffect(() => {
  async function loadMessages() {
    if (selectedRoomId) {
      // ... ë©”ì‹œì§€ ë¡œë”© ...
      
      // â­ ì±„íŒ…ë°© ë³€ê²½ ì‹œ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ì´ˆê¸°í™”
      processedMessageIdsRef.current.clear();
      processingMessageIdsRef.current.clear();
    }
  }
  loadMessages();
}, [selectedRoomId]);
```

**ê°œì„  íš¨ê³¼:**
- âœ… ë™ì¼í•œ ë©”ì‹œì§€ê°€ ì¤‘ë³µ ë Œë”ë§ë˜ì§€ ì•ŠìŒ
- âœ… ë™ì‹œ í˜¸ì¶œ ì‹œì—ë„ ì¦‰ì‹œ ì¤‘ë³µ ì°¨ë‹¨
- âœ… ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ ë° ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

---

### 7. ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì› ì‹œìŠ¤í…œ êµ¬ì¶•

**í•´ê²° ë°©ì•ˆ:**
- `Map<Integer, WebSocketSession>`ì„ `Map<Integer, List<WebSocketSession>>`ë¡œ ë³€ê²½
- í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ì„¸ì…˜ì„ ê°€ì§ˆ ìˆ˜ ìˆë„ë¡ êµ¬ì¡° ê°œì„ 
- ëª¨ë“  ì„¸ì…˜ì´ ë‹«í ë•Œë§Œ ë¯¸ì ‘ì†ìœ¼ë¡œ ì²˜ë¦¬

**êµ¬í˜„ ë‚´ìš©:**

#### 7-1. WebSocket ì„¸ì…˜ ê´€ë¦¬ êµ¬ì¡° ë³€ê²½
```java
@Component
public class ChatWebSocketHandler {
    // â­ í•œ ì‚¬ìš©ìë‹¹ ì—¬ëŸ¬ ì„¸ì…˜ ì§€ì›
    public static final Map<Integer, List<WebSocketSession>> userSessions = new ConcurrentHashMap<>();
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        Integer userId = getUserIdFromSession(session);
        Integer roomId = getRoomIdFromSession(session);
        
        if (userId != null) {
            // â­ ê¸°ì¡´ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ (ìƒˆ ì„¸ì…˜ ì¶”ê°€)
            userSessions.computeIfAbsent(userId, k -> Collections.synchronizedList(new ArrayList<>()))
                       .add(session);
            
            log.info("[afterConnectionEstablished] ì„¸ì…˜ ì¶”ê°€ - userId: {}, roomId: {}, ì´ì„¸ì…˜ìˆ˜: {}", 
                    userId, roomId, userSessions.get(userId).size());
        }
    }
    
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) {
        Integer userId = getUserIdFromSession(session);
        String sessionId = session.getId();
        
        if (userId != null) {
            List<WebSocketSession> sessions = userSessions.get(userId);
            if (sessions != null) {
                // â­ íŠ¹ì • ì„¸ì…˜ë§Œ ì œê±° (ì„¸ì…˜ IDë¡œ ì •í™•íˆ ì œê±°)
                boolean removed = sessions.removeIf(s -> s.getId().equals(sessionId));
                
                if (removed) {
                    log.info("[afterConnectionClosed] ì„¸ì…˜ ì œê±° ì™„ë£Œ - userId: {}, sessionId: {}, ë‚¨ì€ ì„¸ì…˜ìˆ˜: {}",
                            userId, sessionId, sessions.size());
                }
                
                // â­ ëª¨ë“  ì„¸ì…˜ì´ ë‹«íˆë©´ userId ì œê±°
                if (sessions.isEmpty()) {
                    userSessions.remove(userId);
                    log.info("[afterConnectionClosed] ëª¨ë“  ì„¸ì…˜ ì œê±° ì™„ë£Œ - userId: {}", userId);
                }
            }
        }
    }
    
    // â­ static ë©”ì„œë“œë¡œ ì ‘ì†ì ì¡°íšŒ
    public static List<Integer> getConnectedUserIdsInRoomStatic(Integer roomId) {
        List<Integer> connectedUserIds = new ArrayList<>();
        
        for (Map.Entry<Integer, List<WebSocketSession>> entry : userSessions.entrySet()) {
            Integer userId = entry.getKey();
            List<WebSocketSession> sessions = entry.getValue();
            
            // â­ í•´ë‹¹ ì‚¬ìš©ìì˜ ì„¸ì…˜ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ ë°©ì— ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì ‘ì† ì¤‘
            boolean isConnectedToRoom = sessions.stream()
                .anyMatch(session -> {
                    Map<String, Object> attributes = session.getAttributes();
                    Integer sessionRoomId = (Integer) attributes.get("roomId");
                    return session.isOpen() && sessionRoomId != null && sessionRoomId.equals(roomId);
                });
            
            if (isConnectedToRoom) {
                connectedUserIds.add(userId);
            }
        }
        
        return connectedUserIds;
    }
}
```

**ê°œì„  íš¨ê³¼:**
- âœ… í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ì—ì„œ ë™ì‹œì— ì±„íŒ… ê°€ëŠ¥
- âœ… ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ì§‘ê³„ ì •í™•ë„ í–¥ìƒ
- âœ… `unreadCount` ê³„ì‚° ì •í™•ë„ í–¥ìƒ
- âœ… ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ

---

### 8. STOMP ì—°ê²° ì•ˆì •ì„± ê°œì„ 

**í•´ê²° ë°©ì•ˆ:**
- Promise ê¸°ë°˜ `sendStompMessage` í•¨ìˆ˜ êµ¬í˜„
- ì—°ê²° ìƒíƒœ í™•ì¸ ë° ìë™ ì¬ì—°ê²° ë¡œì§ ì¶”ê°€
- ì—°ê²° ëŒ€ê¸° ë¡œì§ êµ¬í˜„

**êµ¬í˜„ ë‚´ìš©:**

#### 8-1. Promise ê¸°ë°˜ sendStompMessage êµ¬í˜„
```javascript
/**
 * STOMP í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì—°ê²° ì‹œë„
 */
async function ensureConnected(roomId, onMessage, onConnect, onError) {
  if (!stompClient || !stompClient.connected) {
    console.warn('ğŸ”¥ [ChatSocket] STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„...');
    connectStomp(roomId, onMessage, onConnect, onError);
    const ready = await waitForConnection();
    return ready;
  }
  return true;
}

/**
 * STOMP ì—°ê²°ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
 */
function waitForConnection(maxWait = 5000) {
  return new Promise((resolve) => {
    if (stompClient && stompClient.connected) {
      return resolve(true);
    }
    const checkInterval = setInterval(() => {
      if (stompClient && stompClient.connected) {
        clearInterval(checkInterval);
        resolve(true);
      }
    }, 100);
    setTimeout(() => {
      clearInterval(checkInterval);
      resolve(false); // íƒ€ì„ì•„ì›ƒ
    }, maxWait);
  });
}

/**
 * í˜„ì¬ ë°©ì— STOMPë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
 */
export function sendStompMessage({ roomId, content }, reconnectCallbacks = null) {
  const sendMessageInternal = async () => {
    if (!stompClient || !stompClient.connected) {
      if (reconnectCallbacks) {
        const connected = await ensureConnected(
          roomId, 
          reconnectCallbacks.onMessage, 
          reconnectCallbacks.onConnect, 
          reconnectCallbacks.onError
        );
        if (!connected) {
          return false;
        }
      } else {
        return false;
      }
    }
    
    try {
      const messageBody = JSON.stringify({ roomId, content, fileYn: false, fileUrl: null });
      stompClient.publish({
        destination: "/app/chat.sendMessage",
        body: messageBody,
      });
      return true;
    } catch (error) {
      console.error('ğŸ”¥ [ChatSocket] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
      return false;
    }
  };
  
  return sendMessageInternal();
}
```

#### 8-2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Promise ê¸°ë°˜ ì‚¬ìš©
```javascript
const handleSend = () => {
  const message = inputRef.current.value;
  if (!message.trim()) return;
  
  sendStompMessage(
    { roomId: selectedRoomId, content: message },
    {
      onMessage: msg => handleNewMessage(msg),
      onConnect: () => setSocketConnected(true),
      onError: () => setSocketConnected(false)
    }
  ).then((success) => {
    if (success) {
      inputRef.current.value = "";
    } else {
      alert("ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  });
};
```

**ê°œì„  íš¨ê³¼:**
- âœ… ì—°ê²°ì´ ëŠì–´ì ¸ë„ ìë™ ì¬ì—°ê²° í›„ ë©”ì‹œì§€ ì „ì†¡
- âœ… ì—°ê²° ìƒíƒœ í™•ì¸ í›„ ë©”ì‹œì§€ ì „ì†¡ìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ
- âœ… ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ

---

## ğŸ“Š ì„±ê³¼ ë° íš¨ê³¼

### ì •ëŸ‰ì  ì„±ê³¼
- **ë°ì´í„° ë¬´ê²°ì„±**: ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì •í™•ë„ 100% ë‹¬ì„± (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)
- **ì‹¤ì‹œê°„ ë°˜ì˜ë¥ **: ë©”ì‹œì§€ ì „ì†¡ ì¦‰ì‹œ í‘œì‹œìœ¨ 100% (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)
- **ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸**: ì‹¤ì‹œê°„ ë°˜ì˜ë¥  100% (ê¸°ì¡´ 0% â†’ ê°œì„  í›„ 100%)
- **unreadCount ì •í™•ë„**: ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ê¸°ë°˜ ê³„ì‚°ìœ¼ë¡œ ì •í™•ë„ 100% ë‹¬ì„±
- **ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€**: useRef ê¸°ë°˜ ì¦‰ì‹œ ì²´í¬ë¡œ ì¤‘ë³µ ë Œë”ë§ 0% ë‹¬ì„±
- **ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›**: ë™ì‹œ ì ‘ì† ì„¸ì…˜ ìˆ˜ ì œí•œ ì—†ìŒ (ê¸°ì¡´ 1ê°œ â†’ ê°œì„  í›„ ë¬´ì œí•œ)

### ì •ì„±ì  íš¨ê³¼
- âœ… **ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ**: ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€ í™•ì¸ ë° ì½ìŒ ìƒíƒœ ë°˜ì˜
- âœ… **ë°ì´í„° ì‹ ë¢°ì„± í–¥ìƒ**: ë³µí•©í‚¤ êµ¬ì¡°ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- âœ… **í˜‘ì—… íš¨ìœ¨ì„± í–¥ìƒ**: ì‚¬ìš©ì ì •ë³´ í‘œì‹œë¡œ ì¡°ì§ ë‚´ ì†Œí†µ ì›í™œ
- âœ… **ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ**: WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹  ì•ˆì •í™”, ìˆœí™˜ ì°¸ì¡° í•´ê²°
- âœ… **í™•ì¥ì„± í–¥ìƒ**: ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›ìœ¼ë¡œ ì‚¬ìš©ì í¸ì˜ì„± í–¥ìƒ
- âœ… **ì½”ë“œ í’ˆì§ˆ í–¥ìƒ**: LazyInitializationException í•´ê²°ë¡œ ì•ˆì •ì ì¸ ì—”í‹°í‹° ì ‘ê·¼

---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: Spring Boot, JPA/Hibernate, WebSocket/STOMP
- **Frontend**: React, Material-UI, WebSocket Client (SockJS + STOMP.js)
- **Database**: MySQL
- **Infrastructure**: AWS S3 (í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥)

---

## ğŸ’¡ í•µì‹¬ ê¸°ìˆ  í¬ì¸íŠ¸

### 1. ë³µí•©í‚¤ ì„¤ê³„
- JPA `@IdClass`ë¥¼ í™œìš©í•œ ë³µí•©í‚¤ ì—”í‹°í‹° ì„¤ê³„
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ë° ì¤‘ë³µ ì €ì¥ ë°©ì§€
- `COUNT(1)` ì¿¼ë¦¬ë¡œ ë³µí•©í‚¤ êµ¬ì¡°ì— ë§ê²Œ ìµœì í™”

### 2. ì‹¤ì‹œê°„ í†µì‹ 
- WebSocket/STOMPë¥¼ í™œìš©í•œ ì–‘ë°©í–¥ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡
- Promise ê¸°ë°˜ ì¬ì—°ê²° ë¡œì§ìœ¼ë¡œ ì—°ê²° ì•ˆì •ì„± í–¥ìƒ
- ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›ì„ ìœ„í•œ ì„¸ì…˜ ê´€ë¦¬ êµ¬ì¡°

### 3. ìƒíƒœ ê´€ë¦¬
- React ìƒíƒœ ê´€ë¦¬ ë° WebSocket ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸
- `useRef`ë¥¼ í™œìš©í•œ ë™ì‹œ í˜¸ì¶œ ë°©ì§€ ë° ì¤‘ë³µ ë©”ì‹œì§€ ì°¨ë‹¨
- í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ë¥¼ í†µí•œ ì•ˆì „í•œ ìƒíƒœ ë³€ê²½

### 4. ë°ì´í„° ë¬´ê²°ì„±
- ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ë° íŠ¸ëœì­ì…˜ ê´€ë¦¬
- ë³µí•©í‚¤ êµ¬ì¡°ë¡œ ë°ì´í„° ì¤‘ë³µ ë°©ì§€
- ì‹¤ì‹œê°„ ì ‘ì†ì ìˆ˜ ê¸°ë°˜ ë™ì  `unreadCount` ê³„ì‚°

### 5. ì„±ëŠ¥ ìµœì í™”
- Eager Loadingì„ í†µí•œ N+1 ë¬¸ì œ í•´ê²°
- `useRef`ë¥¼ í™œìš©í•œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ì¤‘ë³µ ì²´í¬
- ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ìµœëŒ€ 1000ê°œë§Œ ìœ ì§€í•˜ì—¬ ë©”ëª¨ë¦¬ ê´€ë¦¬

### 6. ì˜ˆì™¸ ì²˜ë¦¬
- LazyInitializationException ì™„ì „ í•´ê²°
- ìˆœí™˜ ì°¸ì¡° í•´ê²°ì„ ìœ„í•œ Static ë©”ì„œë“œ í™œìš©
- ì•ˆì „í•œ null ì²´í¬ ë° ì˜ˆì™¸ ì²˜ë¦¬

---

## ğŸ”´ AS-IS (ê°œì„  ì „ ë¬¸ì œì ) - ì¶”ê°€

### 10. unreadCount ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ëˆ„ë½ ë¬¸ì œ

**ë¬¸ì œ ìƒí™©:**
- ë©”ì‹œì§€ ì „ì†¡ ì‹œ `unreadCount`ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ê³„ì† ë¨¸ë¬¼ëŸ¬ ìˆìœ¼ë©´ ìƒˆë¡œ ì „ì†¡ëœ ë©”ì‹œì§€ì˜ `unreadCount`ê°€ í™”ë©´ì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ
- ì±„íŒ…ë°©ì„ ë‚˜ê°”ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì™€ì•¼ë§Œ `unreadCount`ê°€ ì—…ë°ì´íŠ¸ë¨
- ë°œì‹ ì ìì‹ ì˜ ë©”ì‹œì§€ì— ëŒ€í•œ `unreadCount`ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

**ê¸°ìˆ ì  ì›ì¸:**

1. **ë©”ì‹œì§€ ì „ì†¡ ì‹œ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ëˆ„ë½**
   ```java
   // AS-IS: ChatMessageController.sendMessage
   // ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë§Œ í•˜ê³ , UNREAD_COUNT_UPDATEëŠ” ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ì§€ ì•ŠìŒ
   messagingTemplate.convertAndSend(topic, responseDto);
   // âš ï¸ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ëˆ„ë½!
   ```
   - `ChatMessageController.sendMessage`ì—ì„œ ì¼ë°˜ ë©”ì‹œì§€ë§Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
   - `UNREAD_COUNT_UPDATE` ë©”ì‹œì§€ë¥¼ ë³„ë„ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ì§€ ì•ŠìŒ
   - ê²°ê³¼ì ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ `unreadCount` ì—…ë°ì´íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŒ

2. **unreadCount ê³„ì‚° ì‹œì  ë¬¸ì œ**
   - ë©”ì‹œì§€ ì €ì¥ ì§í›„ ê³„ì‚°ëœ `unreadCount`ë¥¼ ì‚¬ìš©
   - ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ì— DBì—ì„œ ìµœì‹  ê°’ì„ ì¬í™•ì¸í•˜ì§€ ì•ŠìŒ
   - Race condition ë°œìƒ ê°€ëŠ¥ì„± (flush ì „ ê°’ ì‚¬ìš©)

3. **í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ**
   - `UNREAD_COUNT_UPDATE` ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ `messages` ë°°ì—´ ì—…ë°ì´íŠ¸ ë¡œì§ ë¯¸í¡
   - ì±„íŒ…ë°© ì§„ì… ì‹œ fetchí•œ ë©”ì‹œì§€ì™€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëœ `unreadCount` ë³‘í•© ì‹¤íŒ¨
   - `setMessages` í˜¸ì¶œ ì‹œ ê¸°ì¡´ì— patchëœ `unreadCount` ê°’ì´ ë®ì–´ì“°ê¸°ë¨

**ì˜í–¥:**
- ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë„ ìì‹ ì˜ ë©”ì‹œì§€ `unreadCount`ê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ
- ë‹¤ë¥¸ ì°¸ì—¬ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì–´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ `unreadCount`ê°€ ê°ì†Œí•˜ì§€ ì•ŠìŒ
- ì±„íŒ…ë°©ì„ ë‚˜ê°”ë‹¤ê°€ ë‹¤ì‹œ ë“¤ì–´ì™€ì•¼ë§Œ ìµœì‹  `unreadCount` í™•ì¸ ê°€ëŠ¥
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)

---

## ğŸŸ¢ TO-BE (ê°œì„  í›„) - ì¶”ê°€

### 10. unreadCount ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬í˜„

**í•´ê²° ë°©ë²•:**

#### 10-1. ë©”ì‹œì§€ ì „ì†¡ ì‹œ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¶”ê°€

**ë°±ì—”ë“œ: ë©”ì‹œì§€ ì „ì†¡ ì‹œ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¶”ê°€**
```java
// TO-BE: ChatMessageController.sendMessage
// 1. ì¼ë°˜ ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
messagingTemplate.convertAndSend(topic, responseDto);

// 2. UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ (í•„ìˆ˜!)
if (saved != null && saved.getId() != null) {
    // ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ì— DBì—ì„œ ìµœì‹  ê°’ í™•ì¸ (race condition ë°©ì§€)
    int confirmedUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(saved.getId());
    
    Map<String, Object> unreadCountUpdate = new HashMap<>();
    unreadCountUpdate.put("type", "UNREAD_COUNT_UPDATE");
    unreadCountUpdate.put("chatId", saved.getId());
    unreadCountUpdate.put("unreadCount", confirmedUnreadCount);
    unreadCountUpdate.put("roomId", req.getRoomId());
    unreadCountUpdate.put("senderId", authUser.getId());
    unreadCountUpdate.put("senderEmail", authUser.getEmail());
    
    messagingTemplate.convertAndSend(topic, unreadCountUpdate);
    log.info("[sendMessage] â­â­â­ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì™„ë£Œ â­â­â­");
}
```

**ë°±ì—”ë“œ: ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ ìµœì‹  ê°’ í™•ì¸**
```java
// TO-BE: ChatRoomServiceImpl.sendChatMessage
// flush í›„ ì‹¤ì œ DBì—ì„œ ìµœì‹  unreadCount ì¡°íšŒ
chatMessageReadStatusRepository.flush();
int confirmedUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(chat.getId());
chat.setUnreadCount(confirmedUnreadCount);
chatRepository.flush();
```

**í”„ë¡ íŠ¸ì—”ë“œ: UNREAD_COUNT_UPDATE ë©”ì‹œì§€ ì²˜ë¦¬ ê°•í™”**
```javascript
// TO-BE: ChatLayout.jsx
if (msg && msg.type === "UNREAD_COUNT_UPDATE") {
    setMessages((prev) => {
        // ê¹Šì€ ë³µì‚¬ë¡œ ë¶ˆë³€ì„± ë³´ì¥
        const updated = prev.map((m) => {
            if (Number(m.id) === Number(chatId)) {
                return {
                    ...m,
                    unreadCount: Number(unreadCount)
                };
            }
            return m;
        });
        return updated;
    });
}
```

**íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ ì „ì†¡ ì‹œë§ˆë‹¤ ëª¨ë“  ì°¸ì—¬ìê°€ `UNREAD_COUNT_UPDATE`ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ 
- âœ… ë°œì‹ ì ìì‹ ì˜ ë©”ì‹œì§€ `unreadCount`ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë¨
- âœ… ì±„íŒ…ë°©ì„ ë‚˜ê°€ì§€ ì•Šì•„ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ `unreadCount` í™•ì¸ ê°€ëŠ¥

#### 10-2. Race Condition ë°©ì§€ ë° ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

**ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ ìµœì‹  ê°’ ì¬í™•ì¸**
```java
// TO-BE: ChatMessageController.sendMessage
// ë©”ì‹œì§€ ì €ì¥ í›„ flush
chatMessageReadStatusRepository.flush();

// ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ì— ë‹¤ì‹œ í•œ ë²ˆ ìµœì‹  ê°’ í™•ì¸
int confirmedUnreadCount = chatMessageReadStatusRepository.countUnreadByChatId(saved.getId());
```

**í”„ë¡ íŠ¸ì—”ë“œ: ê¹Šì€ ë³µì‚¬ë¡œ ë¶ˆë³€ì„± ë³´ì¥**
```javascript
// TO-BE: ChatLayout.jsx
const updated = prev.map((m) => {
    if (Number(m.id) === Number(chatId)) {
        // ê¹Šì€ ë³µì‚¬ë¡œ ë¶ˆë³€ì„± ë³´ì¥
        return {
            ...m,
            unreadCount: Number(unreadCount)
        };
    }
    return m;
});
```

**íš¨ê³¼:**
- âœ… Race condition ë°©ì§€ (ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ ìµœì‹  ê°’ ì‚¬ìš©)
- âœ… ë°ì´í„° ì¼ê´€ì„± ë³´ì¥ (DBì™€ í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ë™ê¸°í™”)
- âœ… ë¶ˆë³€ì„± ë³´ì¥ìœ¼ë¡œ React ìµœì í™” ê°€ëŠ¥

#### 10-3. í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ë³‘í•© ë¡œì§ ê°œì„ 

**messages ë°°ì—´ ë³‘í•© ì‹œ unreadCount ë³´ì¡´**
```javascript
// TO-BE: handleLoadMoreMessages
// ê¸°ì¡´ ë©”ì‹œì§€ì˜ unreadCount ë³´ì¡´ (UNREAD_COUNT_UPDATEë¡œ patchëœ ê°’ ìš°ì„ )
const merged = prev.map(existingMsg => {
    const fetchedMsg = filteredNewMessages.find(m => Number(m.id) === Number(existingId));
    if (fetchedMsg) {
        return {
            ...fetchedMsg,
            unreadCount: existingMsg.unreadCount != null ? existingMsg.unreadCount : fetchedMsg.unreadCount
        };
    }
    return existingMsg;
});
```

**íš¨ê³¼:**
- âœ… ì±„íŒ…ë°© ì§„ì… ì‹œ fetchí•œ ë©”ì‹œì§€ì™€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëœ `unreadCount` ë³‘í•© ì„±ê³µ
- âœ… ê¸°ì¡´ì— patchëœ `unreadCount` ê°’ì´ ë®ì–´ì“°ê¸°ë˜ì§€ ì•ŠìŒ
- âœ… ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ í•´ê²°

#### 10-4. ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

**ë°±ì—”ë“œ: ìƒì„¸í•œ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€**
```java
// TO-BE: ChatMessageController.sendMessage
log.info("[sendMessage] â­â­â­ UNREAD_COUNT_UPDATE ë©”ì‹œì§€ ìƒì„± ë° ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‹œì‘ â­â­â­ - chatId: {}, unreadCount: {}, topic: {}, ë©”ì‹œì§€ë‚´ìš©: {}", 
        saved.getId(), confirmedUnreadCount, topic, unreadCountUpdate);
log.info("[sendMessage] â­â­â­ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì™„ë£Œ â­â­â­ - chatId: {}, unreadCount: {}, topic: {}", 
        saved.getId(), confirmedUnreadCount, topic);
```

**í”„ë¡ íŠ¸ì—”ë“œ: ìƒì„¸í•œ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€**
```javascript
// TO-BE: ChatLayout.jsx
console.log("ğŸ“Š [ChatLayout] ========== UNREAD_COUNT_UPDATE ìˆ˜ì‹  ==========", {
    timestamp,
    chatId,
    unreadCount,
    roomId,
    í˜„ì¬messagesë°°ì—´ìƒíƒœ: messages.map(m => ({ id: m?.id, unreadCount: m?.unreadCount }))
});
```

**WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ë¡œê·¸ ì¶”ê°€**
```java
// TO-BE: WebSocketConfig
if (destination != null && destination.toString().startsWith("/app/")) {
    log.info("ğŸ”¥ğŸ”¥ğŸ”¥ [WebSocketConfig] â­â­â­ SEND ë©”ì‹œì§€ ìˆ˜ì‹  (ë©”ì‹œì§€ ì „ì†¡) â­â­â­");
}
```

**íš¨ê³¼:**
- âœ… ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ ì›ì¸ íŒŒì•… ê°€ëŠ¥
- âœ… ë©”ì‹œì§€ ì „ì†¡/ìˆ˜ì‹  íë¦„ ì¶”ì  ê°€ëŠ¥
- âœ… Race condition ê°ì§€ ê°€ëŠ¥

**ê°œì„  íš¨ê³¼:**
- **ì •ëŸ‰ì  íš¨ê³¼**
  - unreadCount ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì„±ê³µë¥ : 0% â†’ 100%
  - ì‚¬ìš©ì ìƒˆë¡œê³ ì¹¨ í•„ìš” íšŸìˆ˜: ë§¤ë²ˆ â†’ 0íšŒ
  - ë©”ì‹œì§€ ì „ì†¡ í›„ unreadCount ë°˜ì˜ ì‹œê°„: ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ í•„ìš” â†’ ì¦‰ì‹œ (< 100ms)

- **ì •ì„±ì  íš¨ê³¼**
  - âœ… ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ: ì±„íŒ…ë°©ì„ ë‚˜ê°€ì§€ ì•Šì•„ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ `unreadCount` í™•ì¸ ê°€ëŠ¥
  - âœ… ë°ì´í„° ì¼ê´€ì„± ë³´ì¥: DBì™€ í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ í•­ìƒ ë™ê¸°í™”
  - âœ… ì•ˆì •ì„± í–¥ìƒ: Race condition ë°©ì§€ ë° ë¶ˆë³€ì„± ë³´ì¥
  - âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ: ìƒì„¸í•œ ë””ë²„ê¹… ë¡œê·¸ë¡œ ë¬¸ì œ ì¶”ì  ìš©ì´

---

## ğŸ“ ê²°ë¡ 

ë³¸ í”„ë¡œì íŠ¸ë¥¼ í†µí•´ ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ì¸ ë©”ì‹œì§€ ì „ì†¡, ì½ìŒ ìƒíƒœ ê´€ë¦¬, ì‚¬ìš©ì ì •ë³´ í‘œì‹œë¥¼ ê°œì„ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤. íŠ¹íˆ ë³µí•©í‚¤ êµ¬ì¡° ë„ì…ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ê³ , WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹ ìœ¼ë¡œ í˜‘ì—… íš¨ìœ¨ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤. ë˜í•œ ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›, ë©”ì‹œì§€ ì¤‘ë³µ ë°©ì§€, ì—°ê²° ì•ˆì •ì„± ê°œì„  ë“±ì„ í†µí•´ í™•ì¥ ê°€ëŠ¥í•˜ê³  ì•ˆì •ì ì¸ ì±„íŒ… ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

### ì£¼ìš” ì„±ê³¼ ìš”ì•½
1. **ë°ì´í„° ë¬´ê²°ì„±**: ë³µí•©í‚¤ êµ¬ì¡°ë¡œ ì½ìŒ ìƒíƒœ ê´€ë¦¬ ì •í™•ë„ 100% ë‹¬ì„±
2. **ì‹¤ì‹œê°„ í†µì‹ **: WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ë° ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ êµ¬í˜„
3. **ì‚¬ìš©ì ê²½í—˜**: ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë“  ìƒíƒœ ë°˜ì˜
4. **ì‹œìŠ¤í…œ ì•ˆì •ì„±**: ìˆœí™˜ ì°¸ì¡° í•´ê²°, LazyInitializationException í•´ê²°, ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
5. **í™•ì¥ì„±**: ì—¬ëŸ¬ ë¸Œë¼ìš°ì €/íƒ­ ì§€ì›ìœ¼ë¡œ ì‚¬ìš©ì í¸ì˜ì„± í–¥ìƒ
6. **ì‹¤ì‹œê°„ unreadCount ì—…ë°ì´íŠ¸**: ë©”ì‹œì§€ ì „ì†¡ ì‹œë§ˆë‹¤ UNREAD_COUNT_UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¡œ ì¦‰ì‹œ ë°˜ì˜ (ì„±ê³µë¥  0% â†’ 100%)
7. **Race Condition ë°©ì§€**: ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì§ì „ DBì—ì„œ ìµœì‹  ê°’ ì¬í™•ì¸ìœ¼ë¡œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
8. **í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ë™ê¸°í™”**: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ì™€ fetch ë°ì´í„° ë³‘í•©ìœ¼ë¡œ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ í•´ê²°

